<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="origin-trial" content="AvVVD0vRFcVG5+Z0vn8wrVPWUt98Q6/e73ZIicw+Noko1IwIrkB1siQlxc+IdvM0nISlKulUqzx2QflMi1YgFA8AAABieyJvcmlnaW4iOiJodHRwOi8vbG9jYWxob3N0OjkwMDAiLCJmZWF0dXJlIjoiV2ViQXNzZW1ibHlKU1Byb21pc2VJbnRlZ3JhdGlvbiIsImV4cGlyeSI6MTczOTkyMzE5OX0=">
    <title>demo</title>
    <link rel="stylesheet" href="./element-ui.css" crossorigin>
    <style>
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
      }

      #video,
      #canvas {
        width: 480px;
        height: 360px;
      }

      #video {
        background-color: #000;
      }

      #mask {
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
        text-align: center;
        top: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .button {
        display: inline-block;
        background-color: #1795FF;
        padding: 8px 10px;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
      }
      .stats {
        margin-left: 10px;
        margin-top: 20px;
      }
      .stats-text {
        color: #1795FF;
        font-weight: bold;
      }
      .stats-text.good {
        color: #67C23A;
      }
      .stats-text.warning {
        color: #E6A23C;
      }
      .stats-text.danger {
        color: #F56C6C;
      }
      .stats-title {
        font-size: 18px;
        font-weight: bold;
        color: #303133;
        margin-bottom: 15px;
        border-bottom: 2px solid #1795FF;
        padding-bottom: 10px;
      }
      .stats-section {
        margin-bottom: 20px;
      }
      .stats-section-title {
        font-size: 14px;
        font-weight: bold;
        color: #606266;
        margin: 15px 0 10px 0;
        background-color: #f5f7fa;
        padding: 8px 12px;
        border-left: 4px solid #1795FF;
      }
      .stats-item {
        display: flex;
        align-items: center;
        padding: 5px 0;
      }
      .stats-label {
        min-width: 150px;
        color: #606266;
      }
      .stats-tip {
        margin-left: 15px;
        font-size: 12px;
        color: #909399;
        font-style: italic;
      }

      .player {
        position: relative;
        /* width: 480px; */
        /* height: 360px; */
        overflow: hidden;
        position: relative;
        margin-left: 10px;
      }
      #slider {
        width: 450px;
        left: 15px;
        position: absolute;
        bottom: 0;
      }

      #url {
        margin-left: 10px;
        width: 480px;
        margin-top: 20px;
      }
      .options {
        margin-left: 10px;
        margin-top: 10px;
      }
      .load {
        margin-left: 10px;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .button-group {
        margin-left: 10px;
      }
      .button-group button + button {
        margin-left: 4px;
      }
      #video-change,
      #audio-change,
      #subtitle-change,
      #play-rate {
        display: none;
        width: 70px;
        margin-top: 10px;
        position: absolute;
        bottom: 0;
        left: 500px;
      }

      #video-change {
        bottom: 70px;
      }
      #audio-change {
        bottom: 140px;
      }
      #subtitle-change {
        bottom: 210px;
      }

      .label {
        color: #606266;
        font-weight: 500;
        user-select: none;
        display: inline-block;
        line-height: 19px;
        font-size: 15px;
      }
      .support {
        margin-left: 10px;
      }

      #canvas-background-2,
      #canvas-background {
        background-color: #000;
        width: 480px;
        height: 360px;
        display: inline-block;
        position: relative;
      }

      #canvas-background {
        overflow: hidden;
      }

      .renderMode {
        margin-top: 10px;
        margin-left: 10px;
      }

      .renderRotate {
        margin-top: 10px;
        margin-left: 10px;
      }

      .flip {
        margin-top: 10px;
        margin-left: 10px;
      }

      .subtitle {
        color: #fff;
        font-size: 14px;
        position: absolute;
        bottom: 12px;
        text-align: center;
        width: 100%;
        /* padding: 0 50px; */
        /* margin: 0 50px; */
      }

      .loading-mask {
        position: absolute;
        z-index: 2000;
        margin: 0;
        top: 0;
        bottom: 0;
        left: 0;
        width: 480px;
        display: none;
      }

      .loading-spinner {
        top: 50%;
        margin-top: -21px;
        width: 100%;
        text-align: center;
        position: absolute;
      }

      .loading-spinner .circular {
        height: 42px;
        width: 42px;
        animation: loading-rotate 2s linear infinite;
      }

      .loading-spinner .circular .path {
        animation: loading-dash 1.5s ease-in-out infinite;
        stroke-dasharray: 90, 150;
        stroke-dashoffset: 0;
        stroke-width: 2;
        stroke: #fff;
        stroke-linecap: round;
      }

      @keyframes loading-rotate {
          to {
              transform: rotate(1turn)
          }
      }
      @keyframes loading-dash {
          0% {
              stroke-dasharray: 1,200;
              stroke-dashoffset: 0
          }

          50% {
              stroke-dasharray: 90,150;
              stroke-dashoffset: -40px
          }

          to {
              stroke-dasharray: 90,150;
              stroke-dashoffset: -120px
          }
      }
    </style>
</head>
<body>

    <div style="margin-left: 10px;">
      æ”¯æŒ mp4ã€movã€mpegtsã€flvã€matroskaã€webmã€aviã€mp3ã€oggã€flacã€aacã€wav å°è£…æ ¼å¼ <br>
      æ”¯æŒ hlsã€dash åè®® ï¼ˆåªæ”¯æŒ url æ’­æ”¾ï¼‰<br>
      æ”¯æŒ vvcã€av1ã€hevcã€h264ã€vp9ã€vp8ã€mpeg4ã€aacã€mp3ã€opusã€speexã€flacã€vorbisã€g711 ç¼–ç  <br>
      æ”¯æŒç›´æ’­ï¼ˆLIVEï¼‰å’Œç‚¹æ’­ï¼ˆVODï¼‰ <br>
      æ”¯æŒæœ¬åœ°æ–‡ä»¶æ’­æ”¾å’Œç½‘ç»œ url åœ°å€æ’­æ”¾ <br>

      demo çš„è§£ç å™¨åœ¨ github ä»“åº“ä¸­ï¼ŒåŠ è½½å¯èƒ½æ¯”è¾ƒæ…¢ã€‚
    </div>

    <div id="url">
      <el-input v-model="url" placeholder="è¯·è¾“å…¥ url åœ°å€">
        <template slot="prepend">url</template>
      </el-input>
      
    </div>

    <div style="margin-left: 10px; margin-top: 10px;">
      <input id="file" type="file" onchange="onFileOpen(this)" />
    </div>

    <div class="options">
      <div id="isLive">
        <el-checkbox v-model="isLive">ç›´æ’­æ¨¡å¼ï¼ˆisLiveï¼‰</el-checkbox>
        <span style="color: #909399; font-size: 12px; margin-left: 10px;">å‹¾é€‰è¡¨ç¤ºç›´æ’­æµï¼Œä¸å‹¾é€‰è¡¨ç¤ºç‚¹æ’­æ–‡ä»¶</span>
      </div>
      <div id="enableSimd">
        <el-checkbox v-model="enableSimd">å¯ç”¨ SIMD åŠ é€Ÿ</el-checkbox>
        <span style="color: #909399; font-size: 12px; margin-left: 10px;">ä½¿ç”¨ WebAssembly SIMD å‘é‡æŒ‡ä»¤åŠ é€Ÿè§£ç ï¼Œæ€§èƒ½æœ€é«˜</span>
      </div>
      <div id="enableWebCodecs">
        <el-checkbox v-model="enableWebCodecs">å¯ç”¨ WebCodecs ç¡¬è§£</el-checkbox>
        <span style="color: #909399; font-size: 12px; margin-left: 10px;">ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿç¼–è§£ç  APIï¼Œæ”¯æŒç¡¬ä»¶åŠ é€Ÿ</span>
      </div>
      <div id="enableHardwareAcceleration">
        <el-checkbox v-model="enableHardwareAcceleration">å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ</el-checkbox>
        <span style="color: #909399; font-size: 12px; margin-left: 10px;">ä½¿ç”¨ GPU ç¡¬ä»¶åŠ é€Ÿè§£ç ï¼ˆéœ€æµè§ˆå™¨æ”¯æŒï¼‰</span>
      </div>
      <div id="enableWorker">
        <el-checkbox v-model="enableWorker">å¯ç”¨ Worker å¤šçº¿ç¨‹</el-checkbox>
        <span style="color: #909399; font-size: 12px; margin-left: 10px;">ä½¿ç”¨ Web Worker å¤šçº¿ç¨‹å¤„ç†ï¼Œæå‡æ€§èƒ½</span>
      </div>
      <div id="useMse">
        <el-checkbox v-model="useMse">ä½¿ç”¨ MSE æ’­æ”¾</el-checkbox>
        <span style="color: #909399; font-size: 12px; margin-left: 10px;">ä½¿ç”¨ Media Source Extensions æ’­æ”¾ï¼ˆé€‚åˆæµåª’ä½“ï¼‰</span>
      </div>
      <div id="enableWebGPU">
        <el-checkbox v-model="enableWebGPU">å¯ç”¨ WebGPU æ¸²æŸ“</el-checkbox>
        <span style="color: #909399; font-size: 12px; margin-left: 10px;">ä½¿ç”¨ WebGPU è¿›è¡Œè§†é¢‘æ¸²æŸ“ï¼Œæ€§èƒ½æ›´å¥½</span>
      </div>
      <div id="loop">
        <el-checkbox v-model="loop">å¾ªç¯æ’­æ”¾</el-checkbox>
        <span style="color: #909399; font-size: 12px; margin-left: 10px;">æ’­æ”¾ç»“æŸåè‡ªåŠ¨é‡æ–°å¼€å§‹</span>
      </div>
      <div id="mediaStreamMode">
        <el-checkbox v-model="mediaStreamMode">MediaStream æ¨¡å¼</el-checkbox>
        <span style="color: #909399; font-size: 12px; margin-left: 10px;">ä½¿ç”¨ MediaStream æ–¹å¼æ’­æ”¾</span>
      </div>

      <br>

      <!-- <div class="loader">
        <span class="label">loader: </span>
        <div id="loader" style="display: inline-block;">
          <el-radio v-model="radio" label="1">Url</el-radio>
          <el-radio v-model="radio" label="2">File</el-radio>
        </div>
      </div> -->

    </div>

    <br>

    <div class="player">
      <div id="canvas-background">
      </div>
      <div id="canvas-background-2" style="display: none;">
      </div>
      <div id="slider">
        <el-slider v-model="currentTime" :max="duration" :disabled="disabled" @change="seek"></el-slider>
      </div>

      <div id="play-rate">
        å€é€Ÿ:
        <el-select v-model="value" @change="changeRate">
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.value"
            :value="item.value">
          </el-option>
        </el-select>
      </div>

      <div id="video-change">
        è§†é¢‘:
        <el-select v-model="value" @change="change">
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.name"
            :value="item.value">
          </el-option>
        </el-select>
      </div>

      <div id="audio-change">
        éŸ³é¢‘:
        <el-select v-model="value" @change="change">
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.name"
            :value="item.value">
          </el-option>
        </el-select>
      </div>

      <div id="subtitle-change">
        å­—å¹•:
        <el-select v-model="value" @change="change">
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.name"
            :value="item.value">
          </el-option>
        </el-select>
      </div>

      <div class="loading-mask" id="loading-mask">
        <div class="loading-spinner">
          <svg viewBox="25 25 50 50" class="circular">
            <circle cx="50" cy="50" r="20" fill="none" class="path">

            </circle>
          </svg>
        </div>
      </div>
    </div>

    <div class="flip">
      <span class="label">ç¿»è½¬: </span>
      <div id="flipHorizontal" style="display: inline-block;">
        <el-checkbox v-model="flipHorizontal">æ°´å¹³ç¿»è½¬</el-checkbox>
      </div>
      <div id="flipVertical" style="display: inline-block; margin-left: 10px;">
        <el-checkbox v-model="flipVertical">å‚ç›´ç¿»è½¬</el-checkbox>
      </div>
    </div>

    <div class="renderMode">
      <span class="label">æ¸²æŸ“æ¨¡å¼: </span>
      <div id="renderMode" style="display: inline-block;">
        <el-radio v-model="radio" label="0">é€‚åº”</el-radio>
        <el-radio v-model="radio" label="1">å¡«å……</el-radio>
      </div>
      <span style="color: #909399; font-size: 12px; margin-left: 10px;">é€‚åº”=ä¿æŒæ¯”ä¾‹ï¼Œå¡«å……=æ‹‰ä¼¸å¡«æ»¡</span>
    </div>

    <div class="renderRotate">
      <span class="label">ç”»é¢æ—‹è½¬: </span>
      <div id="renderRotate" style="display: inline-block;">
        <el-radio v-model="radio" label="0">0Â°</el-radio>
        <el-radio v-model="radio" label="90">90Â°</el-radio>
        <el-radio v-model="radio" label="180">180Â°</el-radio>
        <el-radio v-model="radio" label="270">270Â°</el-radio>
      </div>
    </div>

    <button id="load" class="load" onclick="loadPlayer('#canvas-background')" disabled>åŠ è½½è§†é¢‘</button>
    <button class="play" onclick="playPlayer()" >æ’­æ”¾</button>
    <button class="play" onclick="pausePlayer()" >æš‚åœ</button>
    <button class="play" onclick="stopPlayer()" >åœæ­¢</button>
    <button onclick="clickAddSubtitle()">æ·»åŠ å­—å¹•</button>
    <input id="subtitleFile" type="file" onchange="addSubtitle(this)" style="display: none;" />
    <!-- <button onclick="openWriteFile()" >write file</button> -->

    <div class="button-group">
      <button onclick="addVolume()">éŸ³é‡ +</button>
      <button onclick="subVolume()">éŸ³é‡ -</button>
      <button onclick="enterFullscreen()">å…¨å±</button>
      <button onclick="resume()">æ¢å¤éŸ³é¢‘</button>
      <button onclick="nextFrame()">ä¸‹ä¸€å¸§</button>
      <button onclick="diagnosticSync()" style="background-color: #E6A23C; color: white;">ğŸ” åŒæ­¥è¯Šæ–­</button>
    </div>

    <br/>

    <div class="stats">
      <div class="stats-title">ğŸ“Š æ’­æ”¾ç»Ÿè®¡ä¿¡æ¯</div>
      
      <div class="stats-section">
        <div class="stats-section-title">ğŸ¬ åŸºç¡€ä¿¡æ¯</div>
        <div class="stats-item">
          <span class="stats-label">éŸ³é¢‘ç¼–ç :</span>
          <span id="audiocodec" class="stats-text"></span>
          <span class="stats-tip">éŸ³é¢‘ç¼–ç æ ¼å¼ï¼ˆAAC/MP3/Opusç­‰ï¼‰</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">è§†é¢‘ç¼–ç :</span>
          <span id="videocodec" class="stats-text"></span>
          <span class="stats-tip">è§†é¢‘ç¼–ç æ ¼å¼ï¼ˆH264/HEVC/AV1ç­‰ï¼‰</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">åˆ†è¾¨ç‡:</span>
          <span id="width" class="stats-text">0</span> x <span id="height" class="stats-text">0</span>
          <span class="stats-tip">è§†é¢‘ç”»é¢å®½åº¦å’Œé«˜åº¦ï¼ˆåƒç´ ï¼‰</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">éŸ³é¢‘å£°é“:</span>
          <span id="channels" class="stats-text">0</span> å£°é“
          <span class="stats-tip">1=å•å£°é“ 2=ç«‹ä½“å£° 6=5.1ç¯ç»•</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">é‡‡æ ·ç‡:</span>
          <span id="sampleRate" class="stats-text">0</span> Hz
          <span class="stats-tip">éŸ³é¢‘é‡‡æ ·é¢‘ç‡ï¼ˆ44100/48000Hzï¼‰</span>
        </div>
      </div>
      <div class="stats-section">
        <div class="stats-section-title">âš¡ æ€§èƒ½æŒ‡æ ‡</div>
        <div class="stats-item">
          <span class="stats-label">éŸ³è§†åŒæ­¥å·®:</span>
          <span id="A_V" class="stats-text">0</span> ms
          <span class="stats-tip">éŸ³è§†é¢‘åŒæ­¥ç¨‹åº¦ï¼Œè¶Šæ¥è¿‘0è¶Šå¥½</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">éŸ³é¢‘å¡é¡¿æ¬¡æ•°:</span>
          <span id="audioStutter" class="stats-text">0</span> æ¬¡
          <span class="stats-tip">éŸ³é¢‘æ’­æ”¾å¡é¡¿çš„ç´¯è®¡æ¬¡æ•°</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">è§†é¢‘å¡é¡¿æ¬¡æ•°:</span>
          <span id="videoStutter" class="stats-text">0</span> æ¬¡
          <span class="stats-tip">è§†é¢‘æ’­æ”¾å¡é¡¿çš„ç´¯è®¡æ¬¡æ•°</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">è§†é¢‘æ¸²æŸ“å¸§ç‡:</span>
          <span id="videoRenderFramerate" class="stats-text">0</span> fps
          <span class="stats-tip">å®é™…æ¸²æŸ“æ˜¾ç¤ºçš„å¸§ç‡</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">è§†é¢‘è§£ç å¸§ç‡:</span>
          <span id="videoDecodeFramerate" class="stats-text">0</span> fps
          <span class="stats-tip">è§£ç å™¨å¤„ç†è§†é¢‘å¸§çš„é€Ÿåº¦</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">éŸ³é¢‘æ¸²æŸ“å¸§ç‡:</span>
          <span id="audioRenderFramerate" class="stats-text">0</span> fps
          <span class="stats-tip">éŸ³é¢‘å¸§çš„æ¸²æŸ“é€Ÿåº¦</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">éŸ³é¢‘è§£ç å¸§ç‡:</span>
          <span id="audioDecodeFramerate" class="stats-text">0</span> fps
          <span class="stats-tip">è§£ç å™¨å¤„ç†éŸ³é¢‘å¸§çš„é€Ÿåº¦</span>
        </div>
      </div>
      <div class="stats-section">
        <div class="stats-section-title">ğŸŒ ç½‘ç»œä¸ç ç‡</div>
        <div class="stats-item">
          <span class="stats-label">å¸¦å®½:</span>
          <span id="bandwidth" class="stats-text">0</span> kbps
          <span class="stats-tip">æ€»å¸¦å®½ä½¿ç”¨ï¼ˆéŸ³é¢‘+è§†é¢‘ï¼‰</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">éŸ³é¢‘ç ç‡:</span>
          <span id="audioBitrate" class="stats-text">0</span> kbps
          <span class="stats-tip">éŸ³é¢‘æµçš„ç ç‡</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">è§†é¢‘ç ç‡:</span>
          <span id="videoBitrate" class="stats-text">0</span> kbps
          <span class="stats-tip">è§†é¢‘æµçš„ç ç‡</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">éŸ³é¢‘ç¼“å†²é˜Ÿåˆ—:</span>
          <span id="audioPacketQueueLength" class="stats-text">0</span> ä¸ª
          <span class="stats-tip">ç­‰å¾…è§£ç çš„éŸ³é¢‘åŒ…æ•°é‡</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">è§†é¢‘ç¼“å†²é˜Ÿåˆ—:</span>
          <span id="videoPacketQueueLength" class="stats-text">0</span> ä¸ª
          <span class="stats-tip">ç­‰å¾…è§£ç çš„è§†é¢‘åŒ…æ•°é‡</span>
        </div>
      </div>
      <div class="stats-section">
        <div class="stats-section-title">ğŸ” é«˜çº§æŒ‡æ ‡</div>
        <div class="stats-item">
          <span class="stats-label">å…³é”®å¸§é—´éš”:</span>
          <span id="keyFrameInterval" class="stats-text">0</span> å¸§
          <span class="stats-tip">GOPå¤§å°ï¼Œå½±å“ seek ç²¾åº¦</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">æŠ–åŠ¨ç¼“å†²åŒºé—´:</span>
          <span id="jitterMin" class="stats-text">0</span> ~ <span id="jitterMax" class="stats-text">0</span>
          <span class="stats-tip">ç¼“å†²åŒºæœ€å°/æœ€å¤§å€¼</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">å½“å‰ç½‘ç»œæŠ–åŠ¨:</span>
          <span id="jitter" class="stats-text">0</span>
          <span class="stats-tip">ç½‘ç»œä¼ è¾“çš„æŠ–åŠ¨ç¨‹åº¦</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">è§†é¢‘è§£ç æœ€å¤§é—´éš”:</span>
          <span id="videoFrameDecodeIntervalMax" class="stats-text">0</span> ms
          <span class="stats-tip">è§£ç ä¸¤å¸§é—´æœ€å¤§æ—¶é—´</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">è§†é¢‘æ¸²æŸ“æœ€å¤§é—´éš”:</span>
          <span id="videoFrameRenderIntervalMax" class="stats-text">0</span> ms
          <span class="stats-tip">æ¸²æŸ“ä¸¤å¸§é—´æœ€å¤§æ—¶é—´</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">éŸ³é¢‘è§£ç æœ€å¤§é—´éš”:</span>
          <span id="audioFrameDecodeIntervalMax" class="stats-text">0</span> ms
          <span class="stats-tip">è§£ç ä¸¤å¸§é—´æœ€å¤§æ—¶é—´</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">éŸ³é¢‘æ¸²æŸ“æœ€å¤§é—´éš”:</span>
          <span id="audioFrameRenderIntervalMax" class="stats-text">0</span> ms
          <span class="stats-tip">æ¸²æŸ“ä¸¤å¸§é—´æœ€å¤§æ—¶é—´</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">è§†é¢‘ç¼–ç å¸§ç‡:</span>
          <span id="videoEncodeFramerate" class="stats-text">0</span> fps
          <span class="stats-tip">æºè§†é¢‘çš„ç¼–ç å¸§ç‡</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">éŸ³é¢‘ç¼–ç å¸§ç‡:</span>
          <span id="audioEncodeFramerate" class="stats-text">0</span> fps
          <span class="stats-tip">æºéŸ³é¢‘çš„ç¼–ç å¸§ç‡</span>
        </div>
      </div>
    </div>
    <div id="ua"></div>

    <script>
      window.CHEAP_DISABLE_THREAD = false
    </script>
    <script src="./sw.js"></script>
    <script id="cheap-polyfill" src="../dist/cheap-polyfill.js"></script>
    <script>
      if (BigInt === Number) {
        window.CHEAP_POLYFILL_URL = document.querySelector('#cheap-polyfill').src
      }
    </script>
    <script src="../dist/avplayer/avplayer.js"></script>
    <script src="./vue.js" crossorigin></script>
    <script src="./element-ui.js" crossorigin></script>

    <!-- <script src="./vconsole.min.js"></script> -->
    <!-- <script>
      var vConsole = new window.VConsole();
    </script> -->

    <script>
      
      
      let player;
      let slider;
      let urlComponent;
      let isLiveComponent;
      let enableSimdComponent;
      let enableWebCodecsComponent;
      let enableHardwareComponent;
      let enableWorkerComponent;
      let useMseComponent;
      let loopComponent;
      let mediaStreamModeComponent;
      let enableWebGPUComponent;
      let renderModeComponent;
      let renderRotateComponent;
      let loaderComponent;
      let playRateComponent;
      let videoChangeComponent;
      let audioChangeComponent;
      let subtitleChangeComponent;
      let isSeeking;
      const sliderRatio = 1000;
      let supportAtomic = true

      const sliderDom = document.querySelector('#slider')
      const playRateDom = document.querySelector('#play-rate')
      const videoChangeDom = document.querySelector('#video-change')
      const audioChangeDom = document.querySelector('#audio-change')
      const subtitleChangeDom = document.querySelector('#subtitle-change')
      const canvasBg = document.querySelector('#canvas-background')
      const video = document.querySelector('#video')
      const audio = document.querySelector('#audio')
      let mediaStreamModeVideo


      class MyIOLoader extends AVPlayer.IOLoader.CustomIOLoader {

        get ext() {
          return this.file.name.split('.').pop()
        }

        get name() {
          return this.file.name
        }

        constructor(file) {
          super()
          this.file = file
          this.loader = new AVPlayer.IOLoader.FileIOLoader()
        }

        async open() {
          return this.loader.open(
            {
              file: this.file
            },
            {
              from: 0,
              to: -1
            }
          )
        }

        async read(buffer) {
          return this.loader.read(buffer)
        }

        async seek(pos) {
          return this.loader.seek(pos)
        }

        async size() {
          return this.loader.size()
        }

        async stop() {
          return this.loader.stop()
        }
      }

      let statsTimer;

      let url = 'https://qnktv.ktvdaren.com/test/7116810.ts'
      let defaultVersion = '-atomic'

      function onFileOpen(target) {

      }

      function openWriteFile() {
        window.showSaveFilePicker({
          suggestedName: 'test_log.mp4'
        }).then((handle) => {
          window.SafeFileIO = new AVPlayer.SafeFileIO(handle)
          window.SafeFileIO.ready().then(() => {
            console.log('test log ready')
          })
        })
      }

      function loadPlayer(id) {

        if (!AVPlayer.audioContext) {
          AVPlayer.audioContext = new AudioContext()
          AVPlayer.audioContext.createBufferSource()
        }

        if (!player) {
          const container = mediaStreamModeComponent.mediaStreamMode ? new MediaStream() : document.querySelector(id)
          player = new AVPlayer({
            container,
            isLive: isLiveComponent.isLive,
            getWasm: (type, codecId) => {
              switch (type) {
                case 'decoder': {

                  if (codecId >= 65536 && codecId <= 65572) {
                    return `../dist/decode/pcm${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                  }
                  if (codecId >= 69632 && codecId <= 69683) {
                    return `../dist/decode/adpcm${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                  }

                  switch (codecId) {
                    // mpeg1/2
                    case 2:
                      return `../dist/decode/mpeg2video${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // H264
                    case 27:
                      return `../dist/decode/h264${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // theora
                    case 30:
                      return `../dist/decode/theora${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // AAC
                    case 86018:
                      return `../dist/decode/aac${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // ac3
                    case 86019:
                      return `../dist/decode/ac3${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // eac3
                    case 86056:
                      return `../dist/decode/eac3${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // dts
                    case 86020:
                      return `../dist/decode/dca${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                      // MP3
                    case 86017:
                      return `../dist/decode/mp3${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // HEVC
                    case 173:
                      return `../dist/decode/hevc${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // VVC
                    case 196:
                      return `../dist/decode/vvc${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // Mpeg4
                    case 12:
                      return `../dist/decode/mpeg4${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // AV1
                    case 225:
                      return `../dist/decode/av1${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // Speex
                    case 86051:
                      return `../dist/decode/speex${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // Opus
                    case 86076:
                      return `../dist/decode/opus${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // flac
                    case 86028:
                      return `../dist/decode/flac${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // vorbis
                    case 86021:
                      return `../dist/decode/vorbis${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // vp8
                    case 139:
                      return `../dist/decode/vp8${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    // vp9
                    case 167:
                      return `../dist/decode/vp9${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                    case 86022 /* AVCodecID.AV_CODEC_ID_DVAUDIO */:
                      return `../dist/decode/dvaudio${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 24 /* AVCodecID.AV_CODEC_ID_DVVIDEO */:
                      return `../dist/decode/dvvideo${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 3 /* AVCodecID.AV_CODEC_ID_H261 */:
                      return `../dist/decode/h261${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 4 /* AVCodecID.AV_CODEC_ID_H263 */:
                    case 20 /* AVCodecID.AV_CODEC_ID_H263I */:
                    case 19 /* AVCodecID.AV_CODEC_ID_H263P */:
                      return `../dist/decode/h263${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 14 /* AVCodecID.AV_CODEC_ID_MSMPEG4V1 */:
                    case 15 /* AVCodecID.AV_CODEC_ID_MSMPEG4V2 */:
                    case 16 /* AVCodecID.AV_CODEC_ID_MSMPEG4V3 */:
                      return `../dist/decode/msmpeg4${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 5 /* AVCodecID.AV_CODEC_ID_RV10 */:
                    case 6 /* AVCodecID.AV_CODEC_ID_RV20 */:
                    case 68 /* AVCodecID.AV_CODEC_ID_RV30 */:
                    case 69 /* AVCodecID.AV_CODEC_ID_RV40 */:
                      return `../dist/decode/msmpeg4${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 86036 /* AVCodecID.AV_CODEC_ID_COOK */:
                    case 86057 /* AVCodecID.AV_CODEC_ID_SIPR */:
                    case 86073 /* AVCodecID.AV_CODEC_ID_RALF */:
                      return `../dist/decode/ra${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 86023 /* AVCodecID.AV_CODEC_ID_WMAV1 */:
                    case 86024 /* AVCodecID.AV_CODEC_ID_WMAV2 */:
                    case 86052 /* AVCodecID.AV_CODEC_ID_WMAVOICE */:
                    case 86054 /* AVCodecID.AV_CODEC_ID_WMALOSSLESS */:
                    case 86053 /* AVCodecID.AV_CODEC_ID_WMAPRO */:
                      return `../dist/decode/wma${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 17 /* AVCodecID.AV_CODEC_ID_WMV1 */:
                    case 18 /* AVCodecID.AV_CODEC_ID_WMV2 */:
                    case 71 /* AVCodecID.AV_CODEC_ID_WMV3 */:
                      return `../dist/decode/wmv${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 7 /* AVCodecID.AV_CODEC_ID_MJPEG */:
                      return `../dist/decode/mjpeg${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 61 /* AVCodecID.AV_CODEC_ID_MJPEG */:
                      return `../dist/decode/png${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 171 /* AVCodecID.AV_CODEC_ID_MJPEG */:
                      return `../dist/decode/webp${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 97 /* AVCodecID.AV_CODEC_ID_MJPEG */:
                      return `../dist/decode/gif${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 96 /* AVCodecID.AV_CODEC_ID_MJPEG */:
                      return `../dist/decode/tiff${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    case 78 /* AVCodecID.AV_CODEC_ID_MJPEG */:
                      return `../dist/decode/bmp${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`;
                    default:
                      return null
                  }
                  break
                }
                case 'resampler':
                  return `../dist/resample/resample${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
                case 'stretchpitcher':
                  return `../dist/stretchpitch/stretchpitch${(enableSimdComponent.enableSimd) ? '-simd' : (supportAtomic ? defaultVersion : '')}.wasm`
              }
            },
            checkUseMES: (streams) => {
              return useMseComponent.useMse
            },
            enableHardware: enableHardwareComponent.enableHardwareAcceleration,
            enableWebCodecs: enableWebCodecsComponent.enableWebCodecs,
            enableWebGPU: enableWebGPUComponent.enableWebGPU,
            enableWorker: enableWorkerComponent.enableWorker,
            loop: loopComponent.loop,
            enableJitterBuffer: true,
            jitterBufferMax: 4,
            jitterBufferMin: 1,
            lowLatency: true,
            // audioWorkletBufferLength: 40,
            drmSystemOptions: {
              // requestUrl: 'https://cwip-shaka-proxy.appspot.com/no_auth',
              headers: {
                'Content-Type': 'application/json',
              }
            }
          })
          if (mediaStreamModeComponent.mediaStreamMode) {
            mediaStreamModeVideo = document.createElement('video')
            mediaStreamModeVideo.style.cssText = `
              width: 100%;
              height: 100%;
            `
            mediaStreamModeVideo.srcObject = container
            document.querySelector(id).appendChild(mediaStreamModeVideo)
          }
          player.on('ended', () => {
            if (statsTimer) {
              clearTimeout(statsTimer)
              statsTimer = null
              handleStats(player.getStats())
            }
            if (slider) {
              slider.currentTime = slider.duration
            }
            // player.destroy().then(() => {
            //   player = null
            //   console.log('player destroy')
            // })
          })
          
          player.on('played', () => {
            if (statsTimer) {
              clearTimeout(statsTimer)
            }
            statsTimer = setInterval(() => {
              handleStats(player.getStats())
            }, 1000)
          })

          player.on('time', (pts) => {
            if (slider && !isSeeking) {
              // ç¡®ä¿ pts æ˜¯æ•°å­—ç±»å‹ï¼Œå•ä½ä¸ºæ¯«ç§’
              const currentTime = typeof pts === 'bigint' ? Number(pts) : Number(pts)
              slider.currentTime = Math.round(currentTime)
            }
          })
          player.on('seeking', () => {
            console.log('seeking...')
            isSeeking = true
          })
          player.on('seeked', () => {
            console.log('seeked')
            setTimeout(() => {
              isSeeking = false
            }, 100)
          })
          player.on('changing', (mediaType, newStreamId, oldStreamId) => {
            console.log('changing', mediaType, newStreamId, oldStreamId)
          })
          player.on('changed', (mediaType, newStreamId, oldStreamId) => {
            console.log('changed', mediaType, newStreamId, oldStreamId)
          })

          player.on('error', (error) => {
            console.log(error)
          })
        }
        else {
          player.options.enableHardware = enableHardwareComponent.enableHardwareAcceleration
          player.options.enableWebCodecs = enableWebCodecsComponent.enableWebCodecs
          player.options.enableWebGPU = enableWebGPUComponent.enableWebGPU
          player.options.container = mediaStreamModeComponent.mediaStreamMode ? new MediaStream() : document.querySelector(id)
          
          if (mediaStreamModeVideo) {
            document.querySelector(id).removeChild(mediaStreamModeVideo)
            mediaStreamModeVideo = null
          }
          if (mediaStreamModeComponent.mediaStreamMode) {
            mediaStreamModeVideo = document.createElement('video')
            mediaStreamModeVideo.style.cssText = `
              width: 100%;
              height: 100%;
            `
            mediaStreamModeVideo.srcObject = player.options.container
            document.querySelector(id).appendChild(mediaStreamModeVideo)
          }
        }
        if (!slider) {
          slider = new Vue({
            el: '#slider',
            data: function() {
              return { 
                currentTime: 0,
                duration: 0
              }
            },
            computed: {
              disabled: function () {
                return this.duration <= 0
              }
            },
            methods: {
              seek() {
                if (!player || isSeeking) {
                  return
                }
                console.log('seek to:', this.currentTime, 'ms')
                isSeeking = true
                // ç¡®ä¿ä¼ å…¥ BigInt ç±»å‹ï¼Œå•ä½ä¸ºæ¯«ç§’
                const seekTime = BigInt(Math.round(this.currentTime))
                player.seek(seekTime).catch((error) => {
                  console.error('seek error:', error)
                  isSeeking = false
                })
              }
            },
            mounted() {
              if (isLiveComponent.isLive) {
                this.$el.style.display = 'none'
              }
              else {
                this.$el.style.display = 'block'
              }
            }
          })
        }
        else {
          if (isLiveComponent.isLive) {
            slider.$el.style.display = 'none'
          }
          else {
            slider.$el.style.display = 'block'
          }
        }

        if (!isLiveComponent.isLive && !playRateComponent) {
          playRateComponent = new Vue({
            el: '#play-rate',
            data: function() {
              return { 
                options: [
                  
                  {
                    value: 0.5
                  },
                  {
                    value: 0.75
                  },
                  {
                    value: 1.0
                  },
                  {
                    value: 1.2
                  },
                  {
                    value: 1.5
                  },
                  {
                    value: 2.0
                  },
                  {
                    value: 3.0
                  },
                  {
                    value: 4.0
                  },
                  {
                    value: 6.0
                  },
                  {
                    value: 8.0
                  }
                ],
                value: 1.0
              }
            },
            methods: {
              changeRate() {
                if (player) {
                  player.setPlaybackRate(this.value)
                }
              }
            },
            mounted: function () {
              this.$el.style.display = 'inline-block'
            }
          })
        }
        else if (isLiveComponent.isLive) {
          playRateDom.style.display = 'none'
        }

        document.querySelector('#loading-mask').style.display = 'block'

        if (slider) {
          slider.currentTime = 0
        }

        player.load(document.querySelector('#file').files[0] ? document.querySelector('#file').files[0] : urlComponent.url, {
          isLive: isLiveComponent.isLive
        }).then(() => {
          
          if (slider) {
            slider.duration = Number(player.getDuration())
          }

          Promise.all([
            player.getVideoList(),
            player.getAudioList(),
            player.getSubtitleList()
          ]).then((data) => {

            let videoList = data[0]
            let audioList = data[1]
            let subtitleList = data[2]

            if (videoList.list.length > 1) {
              if (videoChangeComponent) {
                videoChangeComponent.$destroy()
                document.querySelector('#video-change').innerHTML = `è§†é¢‘:
                <el-select v-model="value" @change="change">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.name"
                    :value="item.value">
                  </el-option>
                </el-select>`
              }
              videoChangeComponent = new Vue({
                el: '#video-change',
                data: function() {
                  return { 
                    options: videoList.list.map((item, index) => {
                      return {
                        value: index,
                        name: `${item.codec}-${item.width}*${item.height}@${item.frameRate}${item.bandwidth ? `-${item.bandwidth}` : ''}`
                      }
                    }),
                    value: videoList.selectedIndex
                  }
                },
                methods: {
                  change() {
                    if (player) {
                      player.selectVideo(this.value)
                    }
                  }
                },
                mounted: function () {
                  this.$el.style.display = 'inline-block'
                }
              })
            }
            else {
              videoChangeDom.style.display = 'none'
            }

            if (audioList.list.length > 1) {
              if (audioChangeComponent) {
                audioChangeComponent.$destroy()
                document.querySelector('#audio-change').innerHTML = `éŸ³é¢‘:
                <el-select v-model="value" @change="change">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.name"
                    :value="item.value">
                  </el-option>
                </el-select>`
              }
              audioChangeComponent = new Vue({
                el: '#audio-change',
                data: function() {
                  return { 
                    options: audioList.list.map((item, index) => {
                      return {
                        value: index,
                        name: `${item.codec}-${item.lang}${item.bandwidth ? `-${item.bandwidth}` : ''}`
                      }
                    }),
                    value: audioList.selectedIndex
                  }
                },
                methods: {
                  change() {
                    if (player) {
                      player.selectAudio(this.value)
                    }
                  }
                },
                mounted: function () {
                  this.$el.style.display = 'inline-block'
                }
              })
            }
            else {
              audioChangeDom.style.display = 'none'
            }

            if (subtitleList.list.length > 1) {
              if (subtitleChangeComponent) {
                subtitleChangeComponent.$destroy()
                document.querySelector('#subtitle-change').innerHTML = `å­—å¹•:
                <el-select v-model="value" @change="change">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.name"
                    :value="item.value">
                  </el-option>
                </el-select>`
              }
              subtitleChangeComponent = new Vue({
                el: '#subtitle-change',
                data: function() {
                  return { 
                    options: subtitleList.list.map((item, index) => {
                      return {
                        value: index,
                        name: `${item.lang}-${item.codec}`
                      }
                    }),
                    value: subtitleList.selectedIndex
                  }
                },
                methods: {
                  change() {
                    if (player) {
                      player.selectSubtitle(this.value)
                    }
                  }
                },
                mounted: function () {
                  this.$el.style.display = 'inline-block'
                }
              })
            }
            else {
              document.querySelector('#subtitle-change').style.display = 'none'
            }

            // player.seek(400000n).then(() => {
              player.play({
                audio: true,
                video: true,
                subtitle: true
              }).then(() => {
                if (mediaStreamModeVideo) {
                  mediaStreamModeVideo.play()
                }
                document.querySelector('#loading-mask').style.display = 'none'
                if (!player.isDash() && !player.isHls()) {
                  const audioStreams = player.getStreams().filter((s => s.mediaType === 'Audio'))
                  const videoStreams = player.getStreams().filter((s => s.mediaType === 'Video'))

                  if (audioStreams.length > 1) {
                    if (audioChangeComponent) {
                      audioChangeComponent.$destroy()
                      document.querySelector('#audio-change').innerHTML = `éŸ³é¢‘:
                      <el-select v-model="value" @change="change">
                        <el-option
                          v-for="item in options"
                          :key="item.value"
                          :label="item.name"
                          :value="item.value">
                        </el-option>
                      </el-select>`
                    }
                    audioChangeComponent = new Vue({
                      el: '#audio-change',
                      data: function() {
                        return { 
                          options: audioStreams.map((item) => {
                            return {
                              value: item.id,
                              name: item.metadata['title'] || item.metadata['languageString'] || item.metadata['language'] || item.metadata['name'] || 'default'
                            }
                          }),
                          value: player.getSelectedAudioStreamId()
                        }
                      },
                      methods: {
                        change() {
                          if (player) {
                            player.selectAudio(this.value)
                          }
                        }
                      },
                      mounted: function () {
                        this.$el.style.display = 'inline-block'
                      }
                    })
                  }
                  else {
                    document.querySelector('#audio-change').style.display = 'none'
                  }

                  if (videoStreams.length > 1) {
                    if (videoChangeComponent) {
                      videoChangeComponent.$destroy()
                      document.querySelector('#video-change').innerHTML = `è§†é¢‘:
                      <el-select v-model="value" @change="change">
                        <el-option
                          v-for="item in options"
                          :key="item.value"
                          :label="item.name"
                          :value="item.value">
                        </el-option>
                      </el-select>`
                    }
                    videoChangeComponent = new Vue({
                      el: '#video-change',
                      data: function() {
                        return { 
                          options: videoStreams.map((item) => {
                            return {
                              value: item.id,
                              name: item.metadata['title'] || item.metadata['languageString'] || item.metadata['language'] || item.metadata['name'] || 'default'
                            }
                          }),
                          value: player.getSelectedVideoStreamId()
                        }
                      },
                      methods: {
                        change() {
                          if (player) {
                            player.selectVideo(this.value)
                          }
                        }
                      },
                      mounted: function () {
                        this.$el.style.display = 'inline-block'
                      }
                    })
                  }
                  else {
                    document.querySelector('#video-change').style.display = 'none'
                  }

                  updateSubtitleList()
                }
              })
            // })
          })
        })

        if (statsTimer) {
          clearTimeout(statsTimer)
        }
        statsTimer = setInterval(() => {
          handleStats(player.getStats())
        }, 1000)
      }

      function addVolume() {
        player.setVolume(player.getVolume() + 0.3)
      }
      function subVolume() {
        player.setVolume(player.getVolume() - 0.3)
      }

      function enterFullscreen() {
        player.enterFullscreen()
      }
      function resume() {
        player.resume()
      }
      function replay() {
        player.replay()
      }

      function playPlayer() {
        if (player) {
          player.play()
        }
      }

      function pausePlayer() {
        if (player) {
          player.pause()
        }
      }

      function stopPlayer() {
        if (player) {
          player.stop().then(() => {
            if (statsTimer) {
            clearTimeout(statsTimer)
            statsTimer = null
            }
            if (slider) {
              slider.currentTime = 0
            }
            // player.destroy().then(() => {
            //   player = null
            //   console.log('player destroy')
            // })
          })
        }
      }

      function updateSubtitleList() {
        if (!player) {
          return
        }
        const subtitleStreams = player.getStreams().filter((s => s.mediaType === 'Subtitle'))
        if (subtitleStreams.length > 1) {
          if (subtitleChangeComponent) {
            subtitleChangeComponent.$destroy()
            document.querySelector('#subtitle-change').innerHTML = `å­—å¹•:
            <el-select v-model="value" @change="change">
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.name"
                :value="item.value">
              </el-option>
            </el-select>`
          }
          subtitleChangeComponent = new Vue({
            el: '#subtitle-change',
            data: function() {
              return { 
                options: subtitleStreams.map((item) => {
                  return {
                    value: item.id,
                    name: item.metadata['title'] || item.metadata['languageString'] || item.metadata['language'] || item.metadata['name'] || 'default'
                  }
                }),
                value: player.getSelectedSubtitleStreamId()
              }
            },
            methods: {
              change() {
                if (player) {
                  player.selectSubtitle(this.value)
                }
              }
            },
            mounted: function () {
              this.$el.style.display = 'inline-block'
            }
          })
        }
        else {
          document.querySelector('#subtitle-change').style.display = 'none'
        }
      }

      function clickAddSubtitle() {
        document.querySelector('#subtitleFile').click()
      }

      function addSubtitle(target) {
        if (player) {
          const file = target.files[0]
          player.loadExternalSubtitle({
            source: file,
            title: file.name.split('.').pop()
          }).then(() => {
            updateSubtitleList()
          })
        }
      }

      function nextFrame() {
        if (player) {
          player.playNextFrame()
        }
      }

      // éŸ³è§†åŒæ­¥è¯Šæ–­å‡½æ•°
      function diagnosticSync() {
        if (!player) {
          alert('è¯·å…ˆåŠ è½½è§†é¢‘ï¼')
          return
        }
        
        const stats = player.getStats()
        
        // å¤„ç† BigInt ç±»å‹
        const audioCurrentTime = typeof stats.audioCurrentTime === 'bigint' ? Number(stats.audioCurrentTime) : stats.audioCurrentTime
        const videoCurrentTime = typeof stats.videoCurrentTime === 'bigint' ? Number(stats.videoCurrentTime) : stats.videoCurrentTime
        const avDiff = audioCurrentTime - videoCurrentTime
        
        console.log('\n=== ğŸ” éŸ³è§†åŒæ­¥è¯Šæ–­æŠ¥å‘Š ===')
        console.log('\nã€åŸå§‹æ•°æ®ã€‘')
        console.log(`éŸ³é¢‘å½“å‰æ—¶é—´ï¼ˆåŸå§‹å€¼ï¼‰: ${audioCurrentTime}`)
        console.log(`è§†é¢‘å½“å‰æ—¶é—´ï¼ˆåŸå§‹å€¼ï¼‰: ${videoCurrentTime}`)
        console.log(`åŒæ­¥å·®ï¼ˆåŸå§‹å€¼ï¼‰: ${avDiff}`)
        
        // æ£€æµ‹æ—¶é—´æˆ³å•ä½
        console.log('\nã€æ—¶é—´æˆ³å•ä½æ£€æµ‹ã€‘')
        const playerCurrentTime = typeof player.getPosition === 'function' ? player.getPosition() : 0  // æ’­æ”¾å™¨å½“å‰ä½ç½®ï¼ˆå¾®ç§’ï¼‰
        const playerTimeNum = typeof playerCurrentTime === 'bigint' ? Number(playerCurrentTime) : playerCurrentTime
        console.log(`æ’­æ”¾å™¨å½“å‰æ—¶é—´: ${playerTimeNum} Î¼s = ${(playerTimeNum/1000).toFixed(2)} ms = ${(playerTimeNum/1000000).toFixed(2)} s`)
        
        let timeUnit = 'ms'
        let audioTimeMs = audioCurrentTime
        let videoTimeMs = videoCurrentTime
        let avDiffMs = avDiff
        
        // å¦‚æœæ—¶é—´æˆ³å€¼è¿‡å¤§ï¼ˆ>100ä¸‡ï¼‰ï¼Œå¯èƒ½æ˜¯å¾®ç§’å•ä½
        if (Math.abs(audioCurrentTime) > 1000000 || Math.abs(videoCurrentTime) > 1000000) {
          console.log('âš ï¸ æ£€æµ‹åˆ°å¼‚å¸¸ï¼šæ—¶é—´æˆ³æ•°å€¼è¿‡å¤§ï¼Œå¯èƒ½å•ä½ä¸ºå¾®ç§’ï¼ˆÎ¼sï¼‰è€Œéæ¯«ç§’ï¼ˆmsï¼‰')
          timeUnit = 'Î¼s'
          audioTimeMs = audioCurrentTime / 1000
          videoTimeMs = videoCurrentTime / 1000
          avDiffMs = avDiff / 1000
          console.log('\nã€å•ä½è½¬æ¢åã€‘')
          console.log(`éŸ³é¢‘å½“å‰æ—¶é—´: ${audioTimeMs.toFixed(2)} ms`)
          console.log(`è§†é¢‘å½“å‰æ—¶é—´: ${videoTimeMs.toFixed(2)} ms`)
          console.log(`åŒæ­¥å·®: ${avDiffMs.toFixed(2)} ms`)
        } else {
          console.log('âœ… æ—¶é—´æˆ³å•ä½æ­£å¸¸ï¼ˆæ¯«ç§’ msï¼‰')
        }
        
        console.log('\nã€æ’­æ”¾å™¨çŠ¶æ€ã€‘')
        const duration = typeof player.getDuration === 'function' ? player.getDuration() : 0
        const durationNum = typeof duration === 'bigint' ? Number(duration) : duration
        console.log(`æ’­æ”¾ä½ç½®: ${(playerTimeNum/1000000).toFixed(2)}ç§’`)
        console.log(`è§†é¢‘æ—¶é•¿: ${(durationNum/1000000).toFixed(2)}ç§’`)
        console.log(`æ’­æ”¾é€Ÿåº¦: ${player.getPlaybackRate()}x`)
        
        console.log('\nã€ç¼–è§£ç ä¿¡æ¯ã€‘')
        console.log(`éŸ³é¢‘ç¼–ç : ${stats.audiocodec || 'æœªçŸ¥'}`)
        console.log(`è§†é¢‘ç¼–ç : ${stats.videocodec || 'æœªçŸ¥'}`)
        console.log(`éŸ³é¢‘è§£ç å™¨: ${stats.audioDecodeName || 'æœªçŸ¥'}`)
        console.log(`è§†é¢‘è§£ç å™¨: ${stats.videoDecodeName || 'æœªçŸ¥'}`)
        console.log(`éŸ³é¢‘è§£ç å¸§ç‡: ${stats.audioDecodeFramerate || 0} fps`)
        console.log(`è§†é¢‘è§£ç å¸§ç‡: ${stats.videoDecodeFramerate || 0} fps`)
        console.log(`éŸ³é¢‘æ¸²æŸ“å¸§ç‡: ${stats.audioRenderFramerate || 0} fps`)
        console.log(`è§†é¢‘æ¸²æŸ“å¸§ç‡: ${stats.videoRenderFramerate || 0} fps`)
        
        console.log('\nã€ç¼“å†²ä¸å¡é¡¿ã€‘')
        console.log(`éŸ³é¢‘å¡é¡¿æ¬¡æ•°: ${stats.audioStutter}`)
        console.log(`è§†é¢‘å¡é¡¿æ¬¡æ•°: ${stats.videoStutter}`)
        console.log(`éŸ³é¢‘ç¼“å†²é˜Ÿåˆ—: ${stats.audioPacketQueueLength} åŒ…`)
        console.log(`è§†é¢‘ç¼“å†²é˜Ÿåˆ—: ${stats.videoPacketQueueLength} åŒ…`)
        
        // éŸ³é¢‘å¼‚å¸¸æ£€æµ‹
        if (audioCurrentTime === 0 && videoCurrentTime > 1000) {
          console.log('\nâš ï¸ ã€æ£€æµ‹åˆ°éŸ³é¢‘å¼‚å¸¸ã€‘')
          console.log('è§†é¢‘æ­£å¸¸æ’­æ”¾ä½†éŸ³é¢‘æ—¶é—´ä¸º 0ï¼Œå¯èƒ½åŸå› ï¼š')
          
          if (!stats.audioDecodeFramerate || stats.audioDecodeFramerate === 0) {
            console.log('âŒ 1. éŸ³é¢‘è§£ç å™¨æœªå·¥ä½œï¼ˆè§£ç å¸§ç‡ = 0ï¼‰')
            console.log('   - å¯èƒ½æ˜¯ TS æµä¸­éŸ³é¢‘è½¨è§£æå¤±è´¥')
            console.log('   - æˆ–è€…éŸ³é¢‘ç¼–è§£ç å™¨ä¸æ”¯æŒ')
          } else {
            console.log(`âœ… éŸ³é¢‘è§£ç å™¨å·¥ä½œæ­£å¸¸ï¼ˆ${stats.audioDecodeFramerate} fpsï¼‰`)
          }
          
          if (!stats.audioRenderFramerate || stats.audioRenderFramerate === 0) {
            console.log('âŒ 2. éŸ³é¢‘æ¸²æŸ“å™¨æœªå·¥ä½œï¼ˆæ¸²æŸ“å¸§ç‡ = 0ï¼‰')
            console.log('   - æµè§ˆå™¨å¯èƒ½è‡ªåŠ¨é™éŸ³äº†éŸ³é¢‘ä¸Šä¸‹æ–‡')
            console.log('   - è¯·ç‚¹å‡»é¡µé¢ä¸Šçš„â€œæ¢å¤éŸ³é¢‘â€æŒ‰é’®')
          } else {
            console.log(`âœ… éŸ³é¢‘æ¸²æŸ“å™¨å·¥ä½œæ­£å¸¸ï¼ˆ${stats.audioRenderFramerate} fpsï¼‰`)
          }
          
          if (stats.audioPacketQueueLength === 0) {
            console.log('âŒ 3. éŸ³é¢‘ç¼“å†²é˜Ÿåˆ—ä¸ºç©º')
            console.log('   - å¯èƒ½ TS æµä¸­æ²¡æœ‰éŸ³é¢‘æ•°æ®')
            console.log('   - æˆ–è€…éŸ³é¢‘æµè§£æå¤±è´¥')
          } else {
            console.log(`âœ… éŸ³é¢‘ç¼“å†²é˜Ÿåˆ—: ${stats.audioPacketQueueLength} åŒ…`)
          }
          
          console.log('\nğŸ’¡ å»ºè®®æ“ä½œï¼š')
          console.log('1. ç‚¹å‡»é¡µé¢ä¸Šçš„â€œæ¢å¤éŸ³é¢‘â€æŒ‰é’®')
          console.log('2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰éŸ³é¢‘è§£ç é”™è¯¯')
          console.log('3. ç¡®è®¤ TS æµæ–‡ä»¶åŒ…å«éŸ³é¢‘è½¨')
        }
        
        let diagnosis = '\nã€è¯Šæ–­ç»“æœã€‘\n'
        const absAvDiff = Math.abs(avDiffMs)
        
        // å¯¹äº TS æµï¼ŒéŸ³è§†é¢‘æ˜¯å¤ç”¨åœ¨ä¸€èµ·çš„ï¼ŒPTS åº”è¯¥åŒæ­¥
        console.log('\nã€TS æµè¯´æ˜ã€‘')
        console.log('TS æµä¸­éŸ³è§†é¢‘æ˜¯å¤ç”¨åœ¨ä¸€èµ·çš„ï¼Œå®ƒä»¬çš„ PTS åº”è¯¥åŸºæœ¬ä¸€è‡´')
        console.log('å¦‚æœéŸ³é¢‘æ—¶é—´ä¸º 0 ä½†è§†é¢‘æ­£å¸¸ï¼Œè¯´æ˜éŸ³é¢‘æµæ²¡æœ‰æ­£å¸¸å·¥ä½œ')
        console.log('å¦‚æœä¸¤è€…éƒ½æœ‰å€¼ä½†å·®è·å¾ˆå¤§ï¼Œå¯èƒ½æ˜¯æ—¶é—´æˆ³å•ä½é”™è¯¯')
        console.log()
        
        if (absAvDiff < 50) {
          diagnosis += 'âœ… åŒæ­¥çŠ¶æ€ï¼šä¼˜ç§€ (< 50ms)'
        } else if (absAvDiff < 200) {
          diagnosis += 'âš ï¸ åŒæ­¥çŠ¶æ€ï¼šè­¦å‘Š (50-200ms)'
          diagnosis += '\nè¯´æ˜ï¼šæœ‰è½»å¾®å»¶è¿Ÿï¼Œä½†é€šå¸¸ä¸å½±å“è§‚çœ‹ä½“éªŒ'
        } else if (absAvDiff < 1000) {
          diagnosis += 'âŒ åŒæ­¥çŠ¶æ€ï¼šå·® (200-1000ms)'
          diagnosis += '\nå»ºè®®ï¼šå¯ç”¨ Worker å¤šçº¿ç¨‹ã€SIMD åŠ é€Ÿå’Œ WebCodecs ç¡¬è§£'
        } else {
          diagnosis += 'ğŸ”¥ åŒæ­¥çŠ¶æ€ï¼šä¸¥é‡é—®é¢˜ (> 1000ms)'
          diagnosis += '\n\nå¯èƒ½åŸå› ï¼š'
          diagnosis += '\n1. æ—¶é—´æˆ³å•ä½é”™è¯¯ï¼ˆå¾®ç§’å½“æˆæ¯«ç§’ï¼‰'
          diagnosis += '\n2. Seek æ“ä½œåæœªæ­£ç¡®åŒæ­¥'
          diagnosis += '\n3. ç»Ÿè®¡æ•°æ®é‡‡é›†å¼‚å¸¸'
          diagnosis += '\n4. Worker æ¨¡å¼ä¸‹æ•°æ®åŒæ­¥é—®é¢˜'
          
          if (timeUnit === 'Î¼s') {
            diagnosis += '\n\nğŸ” å‘ç°é—®é¢˜ï¼šç»Ÿè®¡æ•°æ®çš„æ—¶é—´æˆ³å•ä½å¯èƒ½æ˜¯å¾®ç§’ï¼ˆÎ¼sï¼‰è€Œéæ¯«ç§’ï¼ˆmsï¼‰ï¼'
            diagnosis += `\nè½¬æ¢åçš„åŒæ­¥å·®åº”ä¸ºï¼š${avDiffMs.toFixed(2)} ms`
          }
        }
        
        console.log(diagnosis)
        console.log('\n================================\n')
        
        if (timeUnit === 'Î¼s') {
          alert(`âš ï¸ æ•°æ®å•ä½å¼‚å¸¸

åŸå§‹åŒæ­¥å·®: ${avDiff.toFixed(2)} Î¼s
å®é™…åŒæ­¥å·®: ${avDiffMs.toFixed(2)} ms

${diagnosis}`)
        } else {
          alert(`éŸ³è§†åŒæ­¥å·®: ${avDiffMs.toFixed(2)} ms\n\n${diagnosis}`)
        }
      }

      const statsKeys = [
        'audiocodec',
        'videocodec',
        'width',
        'height',
        'channels',
        'sampleRate',
        'bandwidth',
        'audioBitrate',
        'videoBitrate',
        'audioPacketQueueLength',
        'videoPacketQueueLength',
        'videoEncodeFramerate',
        'videoDecodeFramerate',
        'videoRenderFramerate',
        'keyFrameInterval',
        'audioEncodeFramerate',
        'audioDecodeFramerate',
        'audioRenderFramerate',
        'audioFrameDecodeIntervalMax',
        'audioFrameRenderIntervalMax',
        'videoFrameDecodeIntervalMax',
        'videoFrameRenderIntervalMax',
        'jitter',
        'audioStutter',
        'videoStutter'
      ]

      function handleStats(stats) {
        statsKeys.forEach((key) => {
          const span = document.querySelector('#' + key)
          if (!span) {
            return
          }
          let value = stats[key]

          if (key === 'audioBitrate' || key === 'videoBitrate' || key === 'bandwidth') {
            value = value * 8 / 1000
          }

          span.textContent = value
          
          // æ·»åŠ é¢œè‰²æç¤º
          span.className = 'stats-text'
          if (key === 'audioStutter' || key === 'videoStutter') {
            if (value === 0) {
              span.className += ' good'
            } else if (value < 5) {
              span.className += ' warning'
            } else {
              span.className += ' danger'
            }
          }
        })

        document.querySelector('#jitterMin').textContent = stats.jitterBuffer.min
        document.querySelector('#jitterMax').textContent = stats.jitterBuffer.max
        
        // éŸ³è§†åŒæ­¥å·®ï¼Œå¹¶æ·»åŠ é¢œè‰²
        let audioTime = typeof stats.audioCurrentTime === 'bigint' ? Number(stats.audioCurrentTime) : stats.audioCurrentTime
        let videoTime = typeof stats.videoCurrentTime === 'bigint' ? Number(stats.videoCurrentTime) : stats.videoCurrentTime
        
        // æ£€æµ‹æ˜¯å¦ä¸ºå¾®ç§’å•ä½ï¼ˆå€¼è¿‡å¤§ï¼‰
        if (Math.abs(audioTime) > 1000000 || Math.abs(videoTime) > 1000000) {
          // è½¬æ¢ä¸ºæ¯«ç§’
          audioTime = audioTime / 1000
          videoTime = videoTime / 1000
        }
        
        const avDiff = Math.round(audioTime - videoTime)
        const avSpan = document.querySelector('#A_V')
        avSpan.textContent = avDiff
        avSpan.className = 'stats-text'
        
        const absAvDiff = Math.abs(avDiff)
        if (absAvDiff < 50) {
          avSpan.className += ' good'  // < 50ms ä¼˜ç§€
        } else if (absAvDiff < 200) {
          avSpan.className += ' warning'  // < 200ms è­¦å‘Š
        } else {
          avSpan.className += ' danger'  // >= 200ms å±é™©
        }
        
        // å¦‚æœåŒæ­¥å·®è¿‡å¤§ï¼Œè¾“å‡ºè­¦å‘Š
        if (absAvDiff > 1000) {
          console.warn(`âš ï¸ éŸ³è§†åŒæ­¥å·®è¿‡å¤§: ${avDiff}ms, éŸ³é¢‘æ—¶é—´: ${Math.round(audioTime)}ms, è§†é¢‘æ—¶é—´: ${Math.round(videoTime)}ms`)
        }
      }
      
      urlComponent = new Vue({
        el: '#url',
        data: function () {
          return {
            url: url
          }
        }
      })

      isLiveComponent = new Vue({
        el: '#isLive',
        data: function () {
          return {
            isLive: false
          }
        }
      })

      useMseComponent = new Vue({
        el: '#useMse',
        data: function () {
          return {
            useMse: false
          }
        }
      })

      enableWebGPUComponent = new Vue({
        el: '#enableWebGPU',
        data: function () {
          return {
            enableWebGPU: true
          }
        }
      })

      loopComponent = new Vue({
        el: '#loop',
        data: function () {
          return {
            loop: false
          }
        },
        watch: {
          loop: function(enable) {
            if (player) {
              player.setLoop(enable)
            }
          }
        }
      })

      mediaStreamModeComponent = new Vue({
        el: '#mediaStreamMode',
        data: function () {
          return {
            mediaStreamMode: false
          }
        }
      })

      enableSimdComponent = new Vue({
        el: '#enableSimd',
        data: function () {
          return {
            enableSimd: false
          }
        }
      })

      enableWebCodecsComponent = new Vue({
        el: '#enableWebCodecs',
        data: function () {
          return {
            enableWebCodecs: true
          }
        }
      })

      enableHardwareComponent = new Vue({
        el: '#enableHardwareAcceleration',
        data: function () {
          return {
            enableHardwareAcceleration: true
          }
        }
      })

      enableWorkerComponent = new Vue({
        el: '#enableWorker',
        data: function () {
          return {
            enableWorker: true
          }
        }
      })

      // loaderComponent = new Vue({
      //   el: '#loader',
      //   data: function () {
      //     return {
      //       radio: '1',
      //     }
      //   },
      // })

      renderModeComponent = new Vue({
        el: '#renderMode',
        data: function () {
          return {
            radio: '0',
          }
        },
        watch: {
          radio: function (value) {
            player.setRenderMode(+value)
          }
        }
      })

      renderRotateComponent = new Vue({
        el: '#renderRotate',
        data: function () {
          return {
            radio: '0',
          }
        },
        watch: {
          radio: function (value) {
            player.setRotate(+value)
          }
        }
      })

      new Vue({
        el: '#flipHorizontal',
        data: function () {
          return {
            flipHorizontal: false
          }
        },
        watch: {
          flipHorizontal: function (enable) {
            if (player) {
              player.enableHorizontalFlip(enable)
            }
          }
        }
      })

      new Vue({
        el: '#flipVertical',
        data: function () {
          return {
            flipVertical: false
          }
        },
        watch: {
          flipVertical: function (enable) {
            if (player) {
              player.enableVerticalFlip(enable)
            }
          }
        }
      })

      document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement == null) {
          player.resize(480, 360)
        }
        else {
          player.resize(screen.width, screen.height)
        }
      });
    
      // AVPlayer.startPipelines().then(() => {
        document.querySelector('#load').disabled = false
        // loadPlayer('#canvas-background')
      // })

      AVPlayer.setLogLevel(1)

      if (typeof crossOriginIsolated === 'boolean' && !crossOriginIsolated) {
        navigator.serviceWorker.ready.then(function(reg) {
          if (!crossOriginIsolated && !navigator.serviceWorker.controller) {
            window.location.reload()
          }
        })
      }

      function testSupportWasmAtomic() {
        const asm = 'AGFzbQEAAAABBgFgAX8BfwISAQNlbnYGbWVtb3J5AgMBgIACAwIBAAcJAQVsb2FkOAAACgoBCAAgAP4SAAAL'
        const binaryData = atob(asm)
        const uint8Array = new Uint8Array(binaryData.length)
        for (let i = 0; i < binaryData.length; i++) {
          uint8Array[i] = binaryData.charCodeAt(i)
        }

        const instance = WebAssembly.compile(uint8Array).then(() => {
          console.log('atomic support')
        }, () => {
          supportAtomic = false
          console.log('atomic not support')
        })
      }

      function testSupportWasmSimd() {
        const asm = 'AGFzbQEAAAABBQFgAAF7AhIBA2VudgZtZW1vcnkCAwGAgAIDAgEACgoBCABBAP0ABAAL'
        const binaryData = atob(asm)
        const uint8Array = new Uint8Array(binaryData.length)
        for (let i = 0; i < binaryData.length; i++) {
          uint8Array[i] = binaryData.charCodeAt(i)
        }

        const instance = WebAssembly.compile(uint8Array).then(() => {
          console.log('wasm simd support')
          enableSimdComponent.enableSimd = true
        }, () => {
          enableSimdComponent.enableSimd = false
          console.log('wasm simd not support')
        })
      }


      document.querySelector('#ua').textContent = navigator.userAgent

      // æ£€æµ‹ SharedArrayBuffer æ”¯æŒ
      function checkSharedArrayBufferSupport() {
        if (typeof SharedArrayBuffer !== 'undefined') {
          console.log('âœ… SharedArrayBuffer æ”¯æŒï¼šWorker å¤šçº¿ç¨‹å¯ç”¨')
          console.log('âœ… crossOriginIsolated:', crossOriginIsolated)
          return true
        } else {
          console.warn('âŒ SharedArrayBuffer ä¸æ”¯æŒï¼šWorker å¤šçº¿ç¨‹ä¸å¯ç”¨')
          console.warn('è¯·ç¡®ä¿æœåŠ¡å™¨é…ç½®äº†æ­£ç¡®çš„ COOP å’Œ COEP å“åº”å¤´')
          if (enableWorkerComponent) {
            enableWorkerComponent.enableWorker = false
          }
          return false
        }
      }

      testSupportWasmAtomic()
      testSupportWasmSimd()
      checkSharedArrayBufferSupport()
    </script>
</body>
</html>