<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ThunderStone + libmedia å®Œæ•´é›†æˆç¤ºä¾‹ v1.1</title>
  <!-- ç‰ˆæœ¬: 1.1 - æ·»åŠ MP3è§£ç å™¨æ”¯æŒ -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      font-size: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 16px;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }
    
    .player-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .player-container {
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
      aspect-ratio: 16/9;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #videoContainer {
      width: 100%;
      height: 100%;
    }
    
    .placeholder {
      color: #666;
      font-size: 18px;
      text-align: center;
    }
    
    .controls {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .input-group {
      margin-bottom: 12px;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      color: #333;
      font-size: 13px;
      font-weight: 600;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      background: #fff;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .button-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #fff;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #667eea;
      color: white;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .info-panel, .log-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .panel-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 13px;
      border-bottom: 1px solid #f5f5f5;
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .info-label {
      color: #666;
      font-weight: 500;
    }
    
    .info-value {
      color: #333;
      font-weight: 600;
      text-align: right;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-init { background: #e3f2fd; color: #1976d2; }
    .status-loading { background: #fff3e0; color: #f57c00; }
    .status-ready { background: #e8f5e9; color: #388e3c; }
    .status-playing { background: #e1f5fe; color: #0288d1; }
    .status-error { background: #ffebee; color: #d32f2f; }
    
    .log-container {
      background: #1a1a1a;
      border-radius: 6px;
      padding: 12px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 11px;
    }
    
    .log-entry {
      padding: 3px 0;
      line-height: 1.6;
    }
    
    .log-time {
      color: #666;
      margin-right: 8px;
    }
    
    .log-info { color: #64b5f6; }
    .log-success { color: #81c784; }
    .log-warning { color: #ffb74d; }
    .log-error { color: #e57373; }
    
    .samples {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 12px;
      margin-top: 10px;
    }
    
    .sample-title {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 8px;
    }
    
    .sample-item {
      padding: 6px 10px;
      background: white;
      border-radius: 4px;
      margin-bottom: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      border: 1px solid #e0e0e0;
    }
    
    .sample-item:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .sample-item:last-child {
      margin-bottom: 0;
    }
    
    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¬ ThunderStone + libmedia å®Œæ•´é›†æˆ</h1>
      <p class="subtitle">é€æ˜è§£å¯† + ç¡¬ä»¶è§£ç  = æè‡´æ€§èƒ½ä½“éªŒ</p>
    </div>
    
    <div class="main-content">
      <div class="player-section">
        <div class="player-container" id="playerContainer">
          <div id="videoContainer"></div>
        </div>
        
        <div class="controls">
          <div class="input-group">
            <label for="videoUrl">ğŸ“¹ è§†é¢‘åœ°å€</label>
            <input 
              type="text" 
              id="videoUrl" 
              placeholder="æ”¯æŒåŠ å¯†/æ˜æ–‡ TSã€M3U8ã€MP4..."
              value="https://qnktv.ktvdaren.com/tempmls/convert/20250407/4115794.ts"
            />
          </div>
          
          <div class="samples">
            <div class="sample-title">ğŸ” ThunderStoneåŠ å¯†è§†é¢‘ï¼ˆç‚¹å‡»å¿«é€Ÿå¡«å……ï¼‰</div>
            <div class="sample-item" data-url="https://qnktv.ktvdaren.com/tempmls/convert/20250407/4115794.ts">
              ğŸµ è¿½æ¢¦çš„å¿ƒ (åŠ å¯†TS)
            </div>
            <div class="sample-item" data-url="https://qnktv.ktvdaren.com/tempmls/convert/20250407/4116492.ts">
              ğŸµ ä¸œåŒ—è¯ (åŠ å¯†TS)
            </div>
            <div class="sample-item" data-url="http://qnktv.ktvdaren.com/tempmls/convert/20250407/4107407.ts">
              ğŸµ é»„æ²³äº²å¨˜ (åŠ å¯†TS)
            </div>
            <div class="sample-item" data-url="http://qnktv.ktvdaren.com/tempmls/convert/20250407/4108989.ts">
              ğŸµ è¥¿æ¨µæƒ…ç¼˜ (åŠ å¯†TS)
            </div>
            <div class="sample-title" style="margin-top: 12px;">ğŸŒ æµ‹è¯•è§†é¢‘ï¼ˆæ˜æ–‡ï¼‰</div>
            <div class="sample-item" data-url="https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8">
              ğŸŒ Muxæµ‹è¯•æµ (HLS)
            </div>
          </div>
          
          <div class="button-group" style="margin-top: 15px;">
            <button id="loadBtn" class="btn-primary">
              ğŸ“¥ åŠ è½½è§†é¢‘
            </button>
            <button id="playBtn" class="btn-secondary" disabled>
              â–¶ï¸ æ’­æ”¾
            </button>
            <button id="pauseBtn" class="btn-secondary" disabled>
              â¸ï¸ æš‚åœ
            </button>
            <button id="stopBtn" class="btn-secondary" disabled>
              â¹ï¸ åœæ­¢
            </button>
          </div>
        </div>
      </div>
      
      <div class="sidebar">
        <div class="info-panel">
          <div class="panel-title">ğŸ“Š æ’­æ”¾ä¿¡æ¯</div>
          
          <div class="info-item">
            <span class="info-label">çŠ¶æ€</span>
            <span class="info-value">
              <span id="statusBadge" class="status-badge status-init">åˆå§‹åŒ–ä¸­</span>
            </span>
          </div>
          
          <div class="info-item">
            <span class="info-label">WASMæ¨¡å—</span>
            <span class="info-value" id="wasmStatus">åŠ è½½ä¸­...</span>
          </div>
          
          <div class="info-item">
            <span class="info-label">è§£å¯†æ¨¡å¼</span>
            <span class="info-value" id="decryptMode">-</span>
          </div>
          
          <div class="info-item">
            <span class="info-label">è§†é¢‘ç¼–ç </span>
            <span class="info-value" id="videoCodec">-</span>
          </div>
          
          <div class="info-item">
            <span class="info-label">åˆ†è¾¨ç‡</span>
            <span class="info-value" id="resolution">-</span>
          </div>
          
          <div class="info-item">
            <span class="info-label">å¸§ç‡</span>
            <span class="info-value" id="fps">-</span>
          </div>
          
          <div class="info-item">
            <span class="info-label">è§£ç æ–¹å¼</span>
            <span class="info-value" id="decodeMode">-</span>
          </div>
        </div>
        
        <div class="log-panel">
          <div class="panel-title">ğŸ“ è¿è¡Œæ—¥å¿—</div>
          <div class="log-container" id="logContainer"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- åŠ è½½ ThunderStone WASM -->
  <script src="./thunder_module.js"></script>
  
  <!-- åŠ è½½ libmedia AVPlayer -->
  <script src="../../dist/avplayer/avplayer.js"></script>
  
  <script>
    // ç®€å•çš„HTTPåŠ è½½å™¨ï¼ˆå¸¦ç¼“å†²åŒºï¼‰
    class SimpleHTTPLoader {
      constructor(url) {
        this.url = url
        this.reader = null
        this.response = null
        this.pos = 0
        this.totalSize = 0
        this.pendingBuffer = null  // ç¼“å­˜æœªæ¶ˆè´¹çš„æ•°æ®
      }
      
      get ext() {
        return this.url.split('.').pop() || 'ts'
      }
      
      get flags() { return 0 }
      get name() { return `SimpleHTTPLoader(${this.url})` }
      get minBuffer() { return 4 }
      
      async open() {
        try {
          console.log('[SimpleHTTPLoader] Opening:', this.url)
          // è·å–æ–‡ä»¶å¤§å°
          const headResp = await fetch(this.url, { method: 'HEAD' })
          const contentLength = headResp.headers.get('Content-Length')
          if (contentLength) {
            this.totalSize = parseInt(contentLength)
          }
          console.log('[SimpleHTTPLoader] Content-Length:', this.totalSize)
          
          // æ‰“å¼€æ•°æ®æµ
          this.response = await fetch(this.url)
          this.reader = this.response.body.getReader()
          this.pos = 0
          this.pendingBuffer = null
          console.log('[SimpleHTTPLoader] Stream opened')
          return 0
        } catch (error) {
          console.error('[SimpleHTTPLoader] open failed:', error)
          return -1
        }
      }
      
      async read(buffer) {
        try {
          let offset = 0
          
          // å…ˆæ¶ˆè´¹ç¼“å­˜çš„æ•°æ®
          if (this.pendingBuffer) {
            const toCopy = Math.min(this.pendingBuffer.length, buffer.length)
            buffer.set(this.pendingBuffer.subarray(0, toCopy), 0)
            offset = toCopy
            this.pos += toCopy
            
            if (toCopy < this.pendingBuffer.length) {
              // è¿˜æœ‰å‰©ä½™ï¼Œä¿ç•™
              this.pendingBuffer = this.pendingBuffer.subarray(toCopy)
              return offset
            } else {
              // å…¨éƒ¨æ¶ˆè´¹å®Œ
              this.pendingBuffer = null
            }
          }
          
          // ä»æµä¸­è¯»å–æ–°æ•°æ®
          while (offset < buffer.length) {
            const { value, done } = await this.reader.read()
            if (done) {
              // EOF: è¿”å›å·²è¯»å–çš„å­—èŠ‚æ•°ï¼ˆå¯èƒ½ä¸º0ï¼‰
              return offset > 0 ? offset : -1
            }
            
            const remaining = buffer.length - offset
            const toCopy = Math.min(value.length, remaining)
            
            buffer.set(value.subarray(0, toCopy), offset)
            offset += toCopy
            this.pos += toCopy
            
            // å¦‚æœæœ‰å‰©ä½™æ•°æ®ï¼Œç¼“å­˜èµ·æ¥
            if (toCopy < value.length) {
              this.pendingBuffer = value.subarray(toCopy)
              break
            }
          }
          
          return offset
        } catch (error) {
          console.error('SimpleHTTPLoader read failed:', error)
          return -1
        }
      }
      
      async seek(pos) {
        try {
          // å…³é—­å½“å‰æµ
          if (this.reader) {
            await this.reader.cancel()
          }
          
          // é‡æ–°æ‰“å¼€å¹¶seek
          this.response = await fetch(this.url, {
            headers: { Range: `bytes=${Number(pos)}-` }
          })
          this.reader = this.response.body.getReader()
          this.pos = Number(pos)
          this.pendingBuffer = null  // æ¸…ç©ºç¼“å­˜
          return 0
        } catch (error) {
          console.error('SimpleHTTPLoader seek failed:', error)
          return -1
        }
      }
      
      async size() {
        return BigInt(this.totalSize || 0)
      }
      
      async stop() {
        if (this.reader) {
          try {
            await this.reader.cancel()
          } catch (e) {}
          this.reader = null
        }
        this.response = null
      }
    }
    
    // ThunderStoneè§£å¯†IOLoader - å¿…é¡»ç»§æ‰¿ AVPlayer.IOLoader.CustomIOLoader
    class ThunderStoneIOLoader extends AVPlayer.IOLoader.CustomIOLoader {
      constructor(options) {
        super()  // è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°
        this.options = options
        this.thunderModule = options.thunderModule
        this.baseLoader = options.baseLoader
        this.currentPos = 0n
        this.headerBuffer = null
        this.isEncrypted = false
        
        // åˆå§‹åŒ–è§£å¯†å™¨
        this.decryptHandle = this.thunderModule._tsInitDecrypt()
        if (!this.decryptHandle) {
          throw new Error('ThunderStoneè§£å¯†å™¨åˆå§‹åŒ–å¤±è´¥')
        }
      }
      
      get ext() { return this.baseLoader.ext }
      get flags() { return this.baseLoader.flags }
      get name() { return `ThunderStone(${this.baseLoader.name})` }
      get minBuffer() { return this.baseLoader.minBuffer }
      
      async open() {
        console.log('[ThunderStoneIOLoader] Opening...')
        const result = await this.baseLoader.open()
        if (result < 0) {
          console.error('[ThunderStoneIOLoader] Base loader open failed')
          return result
        }
        
        console.log('[ThunderStoneIOLoader] Reading header...')
        // è¯»å–512å­—èŠ‚å¤´éƒ¨æ£€æŸ¥æ˜¯å¦åŠ å¯†
        this.headerBuffer = new Uint8Array(512)
        let headerRead = 0
        while (headerRead < 512) {
          const ret = await this.baseLoader.read(this.headerBuffer.subarray(headerRead))
          if (ret < 0) {
            console.error('[ThunderStoneIOLoader] Header read failed')
            return -1
          }
          headerRead += ret
        }
        
        console.log('[ThunderStoneIOLoader] Checking encryption...')
        // æ£€æŸ¥æ˜¯å¦ä¸ºåŠ å¯†æµï¼ˆæ³¨æ„ï¼š_tsCheckDecrypt åªæ˜¯æ£€æŸ¥ï¼Œä¸ä¼šä¿®æ”¹æ•°æ®ï¼‰
        const bufferPtr = this.thunderModule._malloc(512)
        try {
          this.thunderModule.HEAPU8.set(this.headerBuffer, bufferPtr)
          const checkResult = this.thunderModule._tsCheckDecrypt(this.decryptHandle, bufferPtr, 512)
          // âš ï¸ æ³¨æ„ï¼šThunderStoneçš„è¿”å›å€¼é€»è¾‘æ˜¯ï¼š0=åŠ å¯†, -3=æ˜æ–‡ï¼ˆä¸å¸¸è§„ç›¸åï¼ï¼‰
          this.isEncrypted = (checkResult === 0)  // ä¿®å¤ï¼š0 è¡¨ç¤ºåŠ å¯†
          
          // æ‰“å°è¯¦ç»†è°ƒè¯•ä¿¡æ¯
          const headerHex = Array.from(this.headerBuffer.slice(0, 32))
            .map(b => b.toString(16).padStart(2, '0')).join(' ')
          const headerAscii = Array.from(this.headerBuffer.slice(0, 32))
            .map(b => (b >= 32 && b < 127) ? String.fromCharCode(b) : '.').join('')
          
          console.log('='.repeat(50))
          console.log('[ThunderStoneIOLoader] åŠ å¯†æ£€æµ‹ç»“æœ:')
          console.log('  checkResult:', checkResult)
          console.log('  isEncrypted:', this.isEncrypted)
          console.log('  å¤´éƒ¨å‰32å­—èŠ‚(HEX):', headerHex)
          console.log('  å¤´éƒ¨å‰32å­—èŠ‚(ASCII):', headerAscii)
          console.log('  âš ï¸ ThunderStoneé€»è¾‘: 0=åŠ å¯†, -3=æ˜æ–‡ (ä¸å¸¸è§„ç›¸å!)')
          console.log('  å®é™…: checkResult ===', checkResult, 'è¡¨ç¤º', this.isEncrypted ? 'åŠ å¯†æµ' : 'æ˜æ–‡æµ')
          console.log('='.repeat(50))
        } finally {
          this.thunderModule._free(bufferPtr)
        }
        
        // æ³¨æ„ï¼šå¤´éƒ¨ä¸éœ€è¦åœ¨è¿™é‡Œè§£å¯†ï¼
        // æ ¹æ® TS ç‰ˆæœ¬å®ç°ï¼ŒcurrentPos ä» 512 å¼€å§‹ï¼Œæ„å‘³ç€å¤´éƒ¨ç›´æ¥è¿”å›åŸå§‹æ•°æ®
        this.currentPos = 512n
        console.log(`ThunderStone: æµç±»å‹ = ${this.isEncrypted ? 'åŠ å¯†' : 'æ˜æ–‡'}`)
        return 0
      }
      
      async read(buffer) {
        // å¦‚æœå¤´éƒ¨è¿˜æœªè¿”å›ï¼Œå…ˆè¿”å›å¤´éƒ¨ï¼ˆåŸå§‹æ•°æ®ï¼Œä¸è§£å¯†ï¼‰
        if (this.headerBuffer) {
          const len = Math.min(buffer.length, this.headerBuffer.length)
          console.log(`[ThunderStoneIOLoader] è¿”å›å¤´éƒ¨: ${len} å­—èŠ‚`)
          buffer.set(this.headerBuffer.subarray(0, len))
          
          if (len < this.headerBuffer.length) {
            this.headerBuffer = this.headerBuffer.subarray(len)
          } else {
            this.headerBuffer = null
            console.log('[ThunderStoneIOLoader] å¤´éƒ¨å·²å…¨éƒ¨è¿”å›ï¼ŒcurrentPos:', this.currentPos)
          }
          return len
        }
        
        // ä»åº•å±‚åŠ è½½å™¨è¯»å–æ•°æ®
        const bytesRead = await this.baseLoader.read(buffer)
        if (bytesRead <= 0) return bytesRead
        
        console.log(`[ThunderStoneIOLoader] è¯»å– ${bytesRead} å­—èŠ‚ï¼ŒcurrentPos: ${this.currentPos}, isEncrypted: ${this.isEncrypted}`)
        
        // å¦‚æœæ˜¯åŠ å¯†æµï¼Œéœ€è¦è§£å¯†
        if (this.isEncrypted) {
          const BLOCK_SIZE = 8192
          let offset = 0
          let decryptCount = 0
          
          while (offset < bytesRead) {
            const blockSize = Math.min(BLOCK_SIZE, bytesRead - offset)
            const bufferPtr = this.thunderModule._malloc(blockSize)
            
            try {
              // å¤åˆ¶æ•°æ®åˆ°WASMå†…å­˜
              this.thunderModule.HEAPU8.set(
                new Uint8Array(buffer.buffer, buffer.byteOffset + offset, blockSize),
                bufferPtr
              )
              
              // è§£å¯†ï¼ˆæ³¨æ„ï¼šcurrentPos ä» 512 å¼€å§‹ï¼Œå› ä¸ºå¤´éƒ¨å·²ç»è¿”å›äº†ï¼‰
              const decryptOffset = Number(this.currentPos) + offset
              const result = this.thunderModule._tsDataDecrypt(
                this.decryptHandle,
                bufferPtr,
                blockSize,
                decryptOffset
              )
              
              if (result !== 0) {
                console.error(`[ThunderStoneIOLoader] è§£å¯†å¤±è´¥: ${result}, offset: ${decryptOffset}`)
              } else {
                decryptCount++
              }
              
              // å¤åˆ¶è§£å¯†åçš„æ•°æ®å›æ¥
              const decrypted = new Uint8Array(
                this.thunderModule.HEAPU8.buffer,
                bufferPtr,
                blockSize
              )
              buffer.set(decrypted, offset)
            } finally {
              this.thunderModule._free(bufferPtr)
            }
            
            offset += blockSize
          }
          
          if (decryptCount > 0) {
            console.log(`[ThunderStoneIOLoader] æˆåŠŸè§£å¯† ${decryptCount} ä¸ªå—`)
          }
        }
        
        this.currentPos += BigInt(bytesRead)
        return bytesRead
      }
      
      async seek(pos) {
        if (this.isEncrypted) {
          this.thunderModule._tsDataDecryptSeek(this.decryptHandle, Number(pos))
        }
        
        const result = await this.baseLoader.seek(pos)
        if (result === 0) {
          this.currentPos = pos
          this.headerBuffer = null
        }
        return result
      }
      
      async size() {
        return await this.baseLoader.size()
      }
      
      async stop() {
        if (this.decryptHandle) {
          this.thunderModule._tsDeinitDecrypt(this.decryptHandle)
          this.decryptHandle = 0
        }
        await this.baseLoader.stop()
      }
    }
    class IntegratedPlayer {
      constructor() {
        this.player = null
        this.thunderModule = null
        this.initUI()
        this.initThunderStone()
      }
      
      initUI() {
        this.elements = {
          loadBtn: document.getElementById('loadBtn'),
          playBtn: document.getElementById('playBtn'),
          pauseBtn: document.getElementById('pauseBtn'),
          stopBtn: document.getElementById('stopBtn'),
          videoUrl: document.getElementById('videoUrl'),
          statusBadge: document.getElementById('statusBadge'),
          wasmStatus: document.getElementById('wasmStatus'),
          decryptMode: document.getElementById('decryptMode'),
          videoCodec: document.getElementById('videoCodec'),
          resolution: document.getElementById('resolution'),
          fps: document.getElementById('fps'),
          decodeMode: document.getElementById('decodeMode'),
          logContainer: document.getElementById('logContainer')
        }
        
        // ç»‘å®šäº‹ä»¶
        this.elements.loadBtn.addEventListener('click', () => this.loadVideo())
        this.elements.playBtn.addEventListener('click', () => this.play())
        this.elements.pauseBtn.addEventListener('click', () => this.pause())
        this.elements.stopBtn.addEventListener('click', () => this.stop())
        
        // ç¤ºä¾‹è§†é¢‘ç‚¹å‡»
        document.querySelectorAll('.sample-item').forEach(item => {
          item.addEventListener('click', () => {
            this.elements.videoUrl.value = item.dataset.url
          })
        })
      }
      
      async initThunderStone() {
        try {
          this.log('æ­£åœ¨åŠ è½½ ThunderStone WASM æ¨¡å—...', 'info')
          
          // ç­‰å¾…Moduleåˆå§‹åŒ–
          await new Promise((resolve) => {
            const check = setInterval(() => {
              if (typeof Module !== 'undefined' && Module._tsInitDecrypt) {
                clearInterval(check)
                resolve()
              }
            }, 100)
          })
          
          this.thunderModule = Module
          this.elements.wasmStatus.textContent = 'âœ… å·²åŠ è½½'
          this.log('âœ… ThunderStone WASM åŠ è½½æˆåŠŸ', 'success')
          this.updateStatus('ready', 'å°±ç»ª')
          
        } catch (error) {
          this.log('âŒ WASMåŠ è½½å¤±è´¥: ' + error.message, 'error')
          this.elements.wasmStatus.textContent = 'âŒ åŠ è½½å¤±è´¥'
          this.updateStatus('error', 'åˆå§‹åŒ–å¤±è´¥')
        }
      }
      
      async loadVideo() {
        const url = this.elements.videoUrl.value.trim()
        if (!url) {
          alert('è¯·è¾“å…¥è§†é¢‘URL')
          return
        }
        
        if (!this.thunderModule) {
          alert('ThunderStone WASMæœªåŠ è½½')
          return
        }
        
        // å¦‚æœå·²æœ‰æ’­æ”¾å™¨ï¼Œå…ˆé”€æ¯
        if (this.player) {
          this.log('ğŸ—‘ï¸ é”€æ¯æ—§æ’­æ”¾å™¨...', 'info')
          try {
            await this.player.destroy()
          } catch (e) {}
          this.player = null
        }
        
        try {
          this.log(`ğŸ“¥ å¼€å§‹åŠ è½½: ${url}`, 'info')
          this.updateStatus('loading', 'åŠ è½½ä¸­')
          
          // 1. åˆ›å»º SimpleHTTPLoader
          this.log('ğŸ”§ åˆ›å»ºHTTPåŠ è½½å™¨...', 'info')
          const baseLoader = new SimpleHTTPLoader(url)
          
          // 2. åˆ›å»º ThunderStoneIOLoader
          this.log('ğŸ” åˆ›å»ºThunderStoneè§£å¯†åŠ è½½å™¨...', 'info')
          const decryptLoader = new ThunderStoneIOLoader({
            thunderModule: this.thunderModule,
            baseLoader: baseLoader
          })
          
          // 3. åˆ›å»º AVPlayer
          this.log('ğŸ¥ åˆ›å»º AVPlayer...', 'info')
          if (!AVPlayer.audioContext) {
            AVPlayer.audioContext = new AudioContext()
          }
          
          this.player = new AVPlayer({
            container: document.getElementById('videoContainer'),
            enableWebCodecs: true,
            enableHardware: true,
            loop: false,
            getWasm: (type, codecId) => {
              console.log('[getWasm] è¯·æ±‚WASM:', { type, codecId })
              // è§†é¢‘è§£ç å™¨
              if (type === 'decoder' && codecId === 27) {
                console.log('[getWasm] è¿”å› h264.wasm')
                return '../../dist/decode/h264.wasm'
              }
              // éŸ³é¢‘è§£ç å™¨
              if (type === 'decoder' && codecId === 86018) {
                console.log('[getWasm] è¿”å› aac.wasm')
                return '../../dist/decode/aac.wasm'
              }
              if (type === 'decoder' && codecId === 86017) {
                console.log('[getWasm] è¿”å› mp3.wasm')
                return '../../dist/decode/mp3.wasm'
              }
              // éŸ³é¢‘é‡é‡‡æ ·å™¨
              if (type === 'resampler') {
                console.log('[getWasm] è¿”å› resample.wasm')
                return '../../dist/resample/resample.wasm'
              }
              // éŸ³é¢‘å˜é€Ÿå˜è°ƒå™¨ (æ³¨æ„æ˜¯ stretchpitcher ä¸æ˜¯ stretchpitch)
              if (type === 'stretchpitcher') {
                console.log('[getWasm] è¿”å› stretchpitch.wasm')
                return '../../dist/stretchpitch/stretchpitch.wasm'
              }
              console.log('[getWasm] æœªåŒ¹é…ï¼Œè¿”å› null')
              return null
            }
          })
          
          // ç›‘å¬äº‹ä»¶
          this.player.on('loaded', () => {
            this.log('âœ… è§†é¢‘åŠ è½½æˆåŠŸ', 'success')
            this.elements.decryptMode.textContent = decryptLoader.isEncrypted ? 'âœ… åŠ å¯†ï¼ˆå·²è§£å¯†ï¼‰' : 'âŒ æ˜æ–‡'
            this.updateStatus('ready', 'å·²åŠ è½½')
            this.elements.playBtn.disabled = false
            
            // è·å–è§†é¢‘ä¿¡æ¯
            const streams = this.player.getStreams()
            if (streams && streams.length > 0) {
              const videoStream = streams.find(s => s.codecpar.codecType === 0) // video
              if (videoStream) {
                this.elements.videoCodec.textContent = this.getCodecName(videoStream.codecpar.codecId)
                this.elements.resolution.textContent = `${videoStream.codecpar.width}x${videoStream.codecpar.height}`
                const fps = videoStream.codecpar.framerate
                if (fps && fps.den) {
                  this.elements.fps.textContent = `${Math.round(fps.num / fps.den)} fps`
                }
              }
            }
            this.elements.decodeMode.textContent = 'WebCodecs ç¡¬è§£'
          })
          
          this.player.on('error', (error) => {
            this.log(`âŒ æ’­æ”¾å™¨é”™è¯¯: ${error.message || error}`, 'error')
            this.updateStatus('error', 'é”™è¯¯')
          })
          
          this.player.on('played', () => {
            this.log('â–¶ï¸ å¼€å§‹æ’­æ”¾', 'success')
            this.updateStatus('playing', 'æ’­æ”¾ä¸­')
          })
          
          this.player.on('paused', () => {
            this.log('â¸ï¸ å·²æš‚åœ', 'info')
            this.updateStatus('ready', 'å·²æš‚åœ')
          })
          
          this.player.on('ended', () => {
            this.log('âœ… æ’­æ”¾ç»“æŸ', 'success')
            this.updateStatus('ready', 'å·²ç»“æŸ')
            this.elements.playBtn.disabled = false
            this.elements.pauseBtn.disabled = true
            this.elements.stopBtn.disabled = true
          })
          
          // 4. åŠ è½½è§†é¢‘ - æ³¨æ„ï¼šä¼ é€’ decryptLoader è€Œä¸æ˜¯ url
          this.log(`ğŸ“‚ åŠ è½½æ–‡ä»¶: ${url}`, 'info')
          
          try {
            await this.player.load(decryptLoader)
            this.log('âœ… load()è°ƒç”¨æˆåŠŸ', 'success')
          } catch (loadError) {
            this.log(`âŒ load()å¤±è´¥: ${loadError.message}`, 'error')
            console.error('Load error details:', loadError)
            throw loadError
          }
          
        } catch (error) {
          this.log(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error')
          this.log(`å †æ ˆ: ${error.stack}`, 'error')
          this.updateStatus('error', 'åŠ è½½å¤±è´¥')
        }
      }
      
      getCodecName(codecId) {
        const codecMap = {
          27: 'H.264',
          173: 'H.265/HEVC',
          225: 'AV1',
          12: 'MPEG-4',
          2: 'MPEG-2',
          86018: 'AAC',
          86017: 'MP3'
        }
        return codecMap[codecId] || `Codec#${codecId}`
      }
      
      async play() {
        if (!this.player) return
        this.log('â–¶ï¸ å¼€å§‹æ’­æ”¾', 'info')
        try {
          await this.player.play()
          this.elements.playBtn.disabled = true
          this.elements.pauseBtn.disabled = false
          this.elements.stopBtn.disabled = false
        } catch (error) {
          this.log(`âŒ æ’­æ”¾å¤±è´¥: ${error.message}`, 'error')
        }
      }
      
      async pause() {
        if (!this.player) return
        this.log('â¸ï¸ æš‚åœæ’­æ”¾', 'info')
        try {
          await this.player.pause()
          this.elements.playBtn.disabled = false
          this.elements.pauseBtn.disabled = true
        } catch (error) {
          this.log(`âŒ æš‚åœå¤±è´¥: ${error.message}`, 'error')
        }
      }
      
      async stop() {
        if (!this.player) return
        this.log('â¹ï¸ åœæ­¢æ’­æ”¾', 'info')
        try {
          await this.player.stop()
          this.elements.playBtn.disabled = false
          this.elements.pauseBtn.disabled = true
          this.elements.stopBtn.disabled = true
        } catch (error) {
          this.log(`âŒ åœæ­¢å¤±è´¥: ${error.message}`, 'error')
        }
      }
      
      updateStatus(type, text) {
        this.elements.statusBadge.className = `status-badge status-${type}`
        this.elements.statusBadge.textContent = text
      }
      
      log(message, level = 'info') {
        const time = new Date().toLocaleTimeString()
        const entry = document.createElement('div')
        entry.className = 'log-entry'
        entry.innerHTML = `
          <span class="log-time">[${time}]</span>
          <span class="log-${level}">${message}</span>
        `
        this.elements.logContainer.appendChild(entry)
        this.elements.logContainer.scrollTop = this.elements.logContainer.scrollHeight
      }
    }
    
    // å¯åŠ¨åº”ç”¨
    window.app = new IntegratedPlayer()
  </script>
</body>
</html>
