<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ThunderStone WASMéªŒè¯</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    .log {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 20px;
      margin-top: 20px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      max-height: 600px;
      overflow-y: auto;
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .log-entry:last-child {
      border-bottom: none;
    }
    .time {
      color: #999;
      margin-right: 10px;
    }
    .info { color: #2196F3; }
    .success { color: #4CAF50; }
    .error { color: #F44336; }
    .warning { color: #FF9800; }
  </style>
</head>
<body>
  <h1>ğŸ” ThunderStone WASMæ¨¡å—éªŒè¯</h1>
  <p>éªŒè¯ThunderStoneè§£å¯†WASMæ¨¡å—æ˜¯å¦æ­£ç¡®åŠ è½½å¹¶å¯ç”¨...</p>
  
  <div class="log" id="logContainer"></div>
  
  <script src="./thunder_module.js"></script>
  <script>
    function log(message, level = 'info') {
      const time = new Date().toLocaleTimeString()
      const entry = document.createElement('div')
      entry.className = 'log-entry'
      entry.innerHTML = `
        <span class="time">[${time}]</span>
        <span class="${level}">${message}</span>
      `
      document.getElementById('logContainer').appendChild(entry)
    }
    
    async function verify() {
      log('â³ ç­‰å¾…ThunderStone WASMæ¨¡å—åˆå§‹åŒ–...', 'info')
      
      // ç­‰å¾…Moduleå¯¹è±¡åˆå§‹åŒ–
      await new Promise((resolve) => {
        const check = setInterval(() => {
          if (typeof Module !== 'undefined' && Module._tsInitDecrypt) {
            clearInterval(check)
            resolve()
          }
        }, 100)
      })
      
      log('âœ… WASMæ¨¡å—åŠ è½½æˆåŠŸ', 'success')
      log('ğŸ” æ£€æŸ¥å¯¼å‡ºå‡½æ•°...', 'info')
      
      // æµ‹è¯•å¿…éœ€å‡½æ•°
      const requiredFunctions = [
        '_tsInitDecrypt',
        '_tsDeinitDecrypt',
        '_tsCheckDecrypt',
        '_tsDataDecrypt',
        '_tsDataDecryptSeek'
      ]
      
      for (const funcName of requiredFunctions) {
        if (Module[funcName]) {
          log(`âœ“ ${funcName}`, 'success')
        } else {
          log(`âœ— ${funcName} ä¸å­˜åœ¨`, 'error')
        }
      }
      
      log('ğŸ§ª æµ‹è¯•è°ƒç”¨ tsInitDecrypt()...', 'info')
      
      try {
        // æµ‹è¯•åˆå§‹åŒ–
        const handle = Module._tsInitDecrypt()
        log(`âœ… åˆå§‹åŒ–æˆåŠŸ, handle = ${handle}`, 'success')
        
        log('ğŸ§ª æµ‹è¯•å¤´éƒ¨æ£€æŸ¥åŠŸèƒ½...', 'info')
        
        // æµ‹è¯•å¤´éƒ¨æ£€æŸ¥
        const testBuffer = new Uint8Array(512)
        const bufferPtr = Module._malloc(testBuffer.length)
        
        try {
          Module.HEAPU8.set(testBuffer, bufferPtr)
          const result = Module._tsCheckDecrypt(handle, bufferPtr, testBuffer.length)
          log(`âœ… å¤´éƒ¨æ£€æŸ¥è°ƒç”¨æˆåŠŸ, result = ${result} (åŠ å¯†)`, 'success')
        } finally {
          Module._free(bufferPtr)
        }
        
        log('ğŸ§¹ æ¸…ç†èµ„æº...', 'info')
        Module._tsDeinitDecrypt(handle)
        log('âœ… æ¸…ç†æˆåŠŸ', 'success')
        
        log('', 'info')
        log('ğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼ThunderStone WASMå¯ç”¨ï¼', 'success')
        log('', 'info')
        log('âœ… ç»“è®º: å¯ä»¥å¼€å§‹Day1å¼€å‘å·¥ä½œ', 'success')
        
      } catch (error) {
        log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
      }
    }
    
    // å¯åŠ¨éªŒè¯
    log('ğŸš€ å¼€å§‹éªŒè¯ThunderStone WASMæ¨¡å—', 'info')
    verify()
  </script>
</body>
</html>
