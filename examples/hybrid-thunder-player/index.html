<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ··åˆæ’­æ”¾å™¨ | Thunderé‰´æƒ + ThunderStoneè§£å¯† + libmediaç¡¬è§£ç </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 12px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .subtitle {
      font-size: 16px;
      opacity: 0.95;
      margin-bottom: 16px;
    }

    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 600;
      margin: 0 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .badge-auth { background: #10b981; color: white; }
    .badge-decrypt { background: #f59e0b; color: white; }
    .badge-hardware { background: #3b82f6; color: white; }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .video-card {
      grid-column: 1;
    }

    .video-container {
      position: relative;
      width: 100%;
      padding-top: 56.25%;
      background: #000;
    }

    #videoContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .controls {
      padding: 24px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 10px;
    }

    .input-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .input-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 13px 26px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .sidebar {
      grid-column: 2;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .info-panel {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .panel-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-grid {
      display: grid;
      gap: 16px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .status-label {
      font-size: 13px;
      color: #6b7280;
      font-weight: 500;
    }

    .status-value {
      font-size: 13px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .status-success { background: #d1fae5; color: #065f46; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-error { background: #fee2e2; color: #991b1b; }
    .status-info { background: #dbeafe; color: #1e40af; }

    .samples {
      background: #f3f4f6;
      border-radius: 10px;
      padding: 16px;
      margin-top: 16px;
    }

    .sample-title {
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .sample-item {
      padding: 12px 14px;
      background: white;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .sample-item:hover {
      border-color: #667eea;
      background: #f0f4ff;
      transform: translateX(4px);
    }

    .log-panel {
      background: #1f2937;
      border-radius: 16px;
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .log-title {
      color: white;
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .log-entry {
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      line-height: 1.6;
    }

    .log-time {
      color: #9ca3af;
      margin-right: 10px;
    }

    .log-info { color: #60a5fa; }
    .log-success { color: #34d399; }
    .log-warn { color: #fbbf24; }
    .log-error { color: #f87171; }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      .sidebar {
        grid-column: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¬ æ··åˆæ’­æ”¾å™¨ç¤ºä¾‹</h1>
      <p class="subtitle">
        <span class="badge badge-auth">âœ“ Thunderé‰´æƒ</span>
        <span class="badge badge-decrypt">âœ“ ThunderStoneè§£å¯†</span>
        <span class="badge badge-hardware">âœ“ libmediaç¡¬è§£ç </span>
      </p>
    </div>

    <div class="main-grid">
      <!-- å·¦ä¾§ï¼šæ’­æ”¾å™¨ -->
      <div class="video-card card">
        <div class="video-container">
          <div id="videoContainer"></div>
        </div>

        <div class="controls">
          <div class="input-group">
            <label>ğŸ“¹ è§†é¢‘åœ°å€</label>
            <input 
              type="text" 
              id="videoUrl" 
              placeholder="è¾“å…¥ThunderStoneåŠ å¯†è§†é¢‘URL..."
              value="https://qnktv.ktvdaren.com/tempmls/convert/20250407/4115794.ts"
            />
          </div>

          <div class="samples">
            <div class="sample-title">ğŸ” æµ‹è¯•è§†é¢‘ï¼ˆThunderStoneåŠ å¯†ï¼‰</div>
            <div class="sample-item" onclick="fillUrl('https://qnktv.ktvdaren.com/tempmls/convert/20250407/4115794.ts')">
              ğŸµ è¿½æ¢¦çš„å¿ƒ (åŠ å¯†TS)
            </div>
            <div class="sample-item" onclick="fillUrl('https://qnktv.ktvdaren.com/tempmls/convert/20250407/4116492.ts')">
              ğŸµ ä¸œåŒ—è¯ (åŠ å¯†TS)
            </div>
          </div>

          <div class="button-group">
            <button id="initBtn" class="btn-primary" onclick="initSystem()">
              ğŸš€ åˆå§‹åŒ–ç³»ç»Ÿ
            </button>
            <button id="loadBtn" class="btn-success" onclick="loadAndPlay()" disabled>
              â–¶ï¸ åŠ è½½å¹¶æ’­æ”¾
            </button>
            <button id="stopBtn" class="btn-danger" onclick="stopPlayback()" disabled>
              â¹ï¸ åœæ­¢
            </button>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šä¿¡æ¯é¢æ¿ -->
      <div class="sidebar">
        <div class="info-panel">
          <div class="panel-title">ğŸ“Š ç³»ç»ŸçŠ¶æ€</div>
          <div class="status-grid">
            <div class="status-item">
              <span class="status-label">é‰´æƒçŠ¶æ€</span>
              <span class="status-value status-pending" id="authStatus">æœªåˆå§‹åŒ–</span>
            </div>
            <div class="status-item">
              <span class="status-label">WASMæ¨¡å—</span>
              <span class="status-value status-pending" id="wasmStatus">æœªåŠ è½½</span>
            </div>
            <div class="status-item">
              <span class="status-label">æ’­æ”¾å™¨</span>
              <span class="status-value status-pending" id="playerStatus">æœªåˆå§‹åŒ–</span>
            </div>
            <div class="status-item">
              <span class="status-label">è§£å¯†æ¨¡å¼</span>
              <span class="status-value status-info" id="decryptMode">-</span>
            </div>
            <div class="status-item">
              <span class="status-label">è§£ç æ–¹å¼</span>
              <span class="status-value status-info" id="decodeMode">-</span>
            </div>
          </div>
        </div>

        <div class="log-panel">
          <div class="log-title">ğŸ“ è¿è¡Œæ—¥å¿—</div>
          <div id="logContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¾èµ–åŠ è½½ -->
  <!-- 1. ThunderStone WASMæ¨¡å— -->
  <script src="../thunder-decrypt/thunder_module.js"></script>
  
  <!-- 2. Thunder Player SDKï¼ˆç”¨äºé‰´æƒï¼‰ -->
  <script src="../../.temp/thunderwebplayer/packages/webplayer-vue/public/js/common.js"></script>
  <script src="../../.temp/thunderwebplayer/packages/webplayer-vue/public/js/pcm-player.js"></script>
  <script src="../../.temp/thunderwebplayer/packages/webplayer-vue/public/js/webgl.js"></script>
  <script src="../../.temp/thunderwebplayer/packages/webplayer-vue/public/js/player.js"></script>
  
  <!-- 3. libmedia AVPlayer -->
  <script src="../../dist/avplayer/avplayer.js"></script>

  <!-- 4. æ··åˆæ’­æ”¾å™¨ç»„ä»¶ -->
  <script src="./ThunderAuthAdapter.js"></script>
  <script src="./HybridThunderStoneIOLoader.js"></script>

  <script>
    // ============================================
    // å…¨å±€çŠ¶æ€
    // ============================================
    const state = {
      authAdapter: null,
      player: null,
      currentLoader: null,
      isInitialized: false
    }

    // ============================================
    // å·¥å…·å‡½æ•°
    // ============================================
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString()
      const entry = document.createElement('div')
      entry.className = `log-entry log-${type}`
      entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`
      
      const container = document.getElementById('logContainer')
      container.appendChild(entry)
      container.scrollTop = container.scrollHeight
      
      console.log(`[${type.toUpperCase()}]`, message)
    }

    function updateStatus(id, text, className) {
      const el = document.getElementById(id)
      el.textContent = text
      el.className = `status-value ${className}`
    }

    function fillUrl(url) {
      document.getElementById('videoUrl').value = url
      log(`URLå·²å¡«å……: ${url.split('/').pop()}`, 'info')
    }

    // ============================================
    // æ­¥éª¤1ï¼šåˆå§‹åŒ–ç³»ç»Ÿ
    // ============================================
    async function initSystem() {
      try {
        log('â•'.repeat(50), 'info')
        log('ğŸš€ å¼€å§‹åˆå§‹åŒ–æ··åˆæ’­æ”¾å™¨ç³»ç»Ÿ...', 'info')
        
        document.getElementById('initBtn').disabled = true

        // 1. æ£€æŸ¥ä¾èµ–
        log('ğŸ“¦ æ£€æŸ¥ä¾èµ–åŠ è½½çŠ¶æ€...', 'info')
        
        // Emscriptenå¯¼å‡ºçš„å…¨å±€å˜é‡æ˜¯ Moduleï¼Œä¸æ˜¯ ThunderModule
        if (typeof Module === 'undefined') {
          throw new Error('ThunderStone WASMæ¨¡å—æœªåŠ è½½ï¼ˆå…¨å±€å˜é‡ Module ä¸å­˜åœ¨ï¼‰')
        }
        if (!Module._tsInitDecrypt) {
          throw new Error('ThunderStone WASMæ¨¡å—ç¼ºå°‘è§£å¯†å‡½æ•°')
        }
        log('  âœ“ ThunderStone WASM', 'success')
        updateStatus('wasmStatus', 'å·²åŠ è½½', 'status-success')
        
        // ä¿å­˜åˆ°å…¨å±€ä»¥ä¾¿å…¶ä»–ä»£ç ä½¿ç”¨
        window.ThunderModule = Module

        if (typeof window.Player === 'undefined') {
          throw new Error('Thunder Player SDKæœªåŠ è½½')
        }
        log('  âœ“ Thunder Player SDK', 'success')

        if (typeof AVPlayer === 'undefined') {
          throw new Error('libmedia AVPlayeræœªåŠ è½½')
        }
        log('  âœ“ libmedia AVPlayer', 'success')

        // 2. åˆå§‹åŒ–Thunderé‰´æƒ
        log('ğŸ” åˆå§‹åŒ–Thunderé‰´æƒ...', 'info')
        updateStatus('authStatus', 'åˆå§‹åŒ–ä¸­...', 'status-pending')

        state.authAdapter = new ThunderAuthAdapter()
        const authResult = await state.authAdapter.init({
          appid: 'b72d8f35e1c7abde45f69c82d7314590',
          uid: `libmedia-${Date.now()}`,
          sdk_sn: 'demo-sdk-sn-001'
        })

        if (!authResult) {
          throw new Error('Thunderé‰´æƒå¤±è´¥')
        }

        log('  âœ“ Thunderé‰´æƒæˆåŠŸ', 'success')
        updateStatus('authStatus', 'å·²é‰´æƒ', 'status-success')

        // 3. åˆ›å»ºlibmediaæ’­æ”¾å™¨
        log('ğŸ¬ åˆ›å»ºlibmediaæ’­æ”¾å™¨...', 'info')
        updateStatus('playerStatus', 'åˆ›å»ºä¸­...', 'status-pending')

        state.player = new AVPlayer({
          container: document.getElementById('videoContainer'),
          enableWorker: true, // å¯ç”¨Workerå¤šçº¿ç¨‹
          enableWebCodecs: true // å¯ç”¨ç¡¬è§£ç 
        })
        
        // ç›‘å¬æ’­æ”¾å™¨äº‹ä»¶
        state.player.on('loaded', () => {
          log('âœ… [æ’­æ”¾å™¨] è§†é¢‘åŠ è½½æˆåŠŸ', 'success')
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] loaded')
        })
        
        state.player.on('playing', () => {
          log('â–¶ï¸ [æ’­æ”¾å™¨] å¼€å§‹æ’­æ”¾', 'success')
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] playing')
        })
        
        state.player.on('paused', () => {
          log('â¸ï¸ [æ’­æ”¾å™¨] å·²æš‚åœ', 'info')
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] paused')
        })
        
        state.player.on('error', (error) => {
          log(`âŒ [æ’­æ”¾å™¨] æ’­æ”¾å™¨é”™è¯¯: ${error.message || error}`, 'error')
          console.error('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] error:', error)
          console.error('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] error.stack:', error.stack)
        })
              
        state.player.on('timeupdate', (time) => {
          console.log(`â±ï¸ [æ’­æ”¾å™¨äº‹ä»¶] timeupdate: ${time.toFixed(2)}s`)
        })
              
        state.player.on('seeking', () => {
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] seeking')
        })
              
        state.player.on('seeked', () => {
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] seeked')
        })
              
        state.player.on('ended', () => {
          log('ğŸ [æ’­æ”¾å™¨] æ’­æ”¾ç»“æŸ', 'info')
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] ended')
        })

        log('  âœ“ libmediaæ’­æ”¾å™¨åˆ›å»ºæˆåŠŸ', 'success')
        updateStatus('playerStatus', 'å°±ç»ª', 'status-success')
        updateStatus('decodeMode', 'WebCodecsç¡¬è§£', 'status-success')

        // 4. å®Œæˆåˆå§‹åŒ–
        state.isInitialized = true
        document.getElementById('loadBtn').disabled = false
        
        log('â•'.repeat(50), 'info')
        log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼å¯ä»¥å¼€å§‹æ’­æ”¾äº†', 'success')
        log('â•'.repeat(50), 'info')

      } catch (error) {
        log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error')
        updateStatus('authStatus', 'å¤±è´¥', 'status-error')
        updateStatus('playerStatus', 'å¤±è´¥', 'status-error')
        document.getElementById('initBtn').disabled = false
      }
    }

    // ============================================
    // æ­¥éª¤2ï¼šåŠ è½½å¹¶æ’­æ”¾è§†é¢‘
    // ============================================
    async function loadAndPlay() {
      if (!state.isInitialized) {
        log('âš ï¸ è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warn')
        return
      }

      try {
        const url = document.getElementById('videoUrl').value.trim()
        if (!url) {
          log('âš ï¸ è¯·è¾“å…¥è§†é¢‘URL', 'warn')
          return
        }

        log('â•'.repeat(50), 'info')
        log(`ğŸµ å¼€å§‹åŠ è½½è§†é¢‘: ${url.split('/').pop()}`, 'info')

        document.getElementById('loadBtn').disabled = true
        document.getElementById('stopBtn').disabled = false

        // 1. åˆ›å»ºæ··åˆIOLoader
        log('ğŸ”§ åˆ›å»ºHybridThunderStoneIOLoader...', 'info')
        state.currentLoader = new HybridThunderStoneIOLoader({
          url: url,
          thunderModule: window.ThunderModule || Module
        })

        // 2. åŠ è½½è§†é¢‘
        log('ğŸ“¥ [æ’­æ”¾å™¨] åŠ è½½è§†é¢‘åˆ°æ’­æ”¾å™¨...', 'info')
        console.log('ğŸš€ [æ’­æ”¾å™¨] è°ƒç”¨ player.load(loader)')
        console.log('ğŸš€ [æ’­æ”¾å™¨] IOLoader:', state.currentLoader)
        
        await state.player.load(state.currentLoader, {
          // å¯é€‰é…ç½®
          isLive: false,
          enableHardware: true
        })
        
        console.log('âœ… [æ’­æ”¾å™¨] load()è¿”å›æˆåŠŸ')
        log('  âœ“ è§†é¢‘åŠ è½½æˆåŠŸ', 'success')

        // 3. å¼€å§‹æ’­æ”¾
        log('â–¶ï¸ å¼€å§‹æ’­æ”¾...', 'info')
        await state.player.play()

        // 4. æ›´æ–°çŠ¶æ€
        const decryptMode = state.currentLoader.isEncrypted ? 'âœ“ ThunderStoneè§£å¯†' : 'â—‹ æ˜æ–‡'
        updateStatus('decryptMode', decryptMode, state.currentLoader.isEncrypted ? 'status-success' : 'status-info')

        log('â•'.repeat(50), 'info')
        log('âœ… æ’­æ”¾æˆåŠŸï¼', 'success')
        log('â•'.repeat(50), 'info')

      } catch (error) {
        log(`âŒ æ’­æ”¾å¤±è´¥: ${error.message}`, 'error')
        console.error('è¯¦ç»†é”™è¯¯:', error)
        document.getElementById('loadBtn').disabled = false
        document.getElementById('stopBtn').disabled = true
      }
    }

    // ============================================
    // æ­¥éª¤3ï¼šåœæ­¢æ’­æ”¾
    // ============================================
    async function stopPlayback() {
      try {
        log('â¹ï¸ åœæ­¢æ’­æ”¾...', 'info')

        if (state.player) {
          await state.player.pause()
        }

        document.getElementById('loadBtn').disabled = false
        document.getElementById('stopBtn').disabled = true

        log('âœ“ å·²åœæ­¢', 'success')
      } catch (error) {
        log(`âŒ åœæ­¢å¤±è´¥: ${error.message}`, 'error')
      }
    }

    // ============================================
    // é¡µé¢åŠ è½½å®Œæˆ
    // ============================================
    window.addEventListener('DOMContentLoaded', () => {
      log('ğŸŒ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å°±ç»ª', 'info')
      log('ğŸ“– è¯·ç‚¹å‡»"åˆå§‹åŒ–ç³»ç»Ÿ"å¼€å§‹', 'info')
    })
  </script>
</body>
</html>
