<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ··åˆæ’­æ”¾å™¨ | Thunderé‰´æƒ + ThunderStoneè§£å¯† + libmediaç¡¬è§£ç </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 12px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .subtitle {
      font-size: 16px;
      opacity: 0.95;
      margin-bottom: 16px;
    }

    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 600;
      margin: 0 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .badge-auth { background: #10b981; color: white; }
    .badge-decrypt { background: #f59e0b; color: white; }
    .badge-hardware { background: #3b82f6; color: white; }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .video-card {
      grid-column: 1;
    }

    .video-container {
      position: relative;
      width: 100%;
      padding-top: 56.25%;
      background: #000;
    }

    #videoContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .controls {
      padding: 24px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 10px;
    }

    .input-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .input-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 13px 26px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .sidebar {
      grid-column: 2;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .info-panel {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .panel-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-grid {
      display: grid;
      gap: 16px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .status-label {
      font-size: 13px;
      color: #6b7280;
      font-weight: 500;
    }

    .status-value {
      font-size: 13px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .status-success { background: #d1fae5; color: #065f46; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-error { background: #fee2e2; color: #991b1b; }
    .status-info { background: #dbeafe; color: #1e40af; }

    .samples {
      background: #f3f4f6;
      border-radius: 10px;
      padding: 16px;
      margin-top: 16px;
    }

    .sample-title {
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .sample-item {
      padding: 12px 14px;
      background: white;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .sample-item:hover {
      border-color: #667eea;
      background: #f0f4ff;
      transform: translateX(4px);
    }

    .log-panel {
      background: #1f2937;
      border-radius: 16px;
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .log-title {
      color: white;
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .log-entry {
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      line-height: 1.6;
    }

    .log-time {
      color: #9ca3af;
      margin-right: 10px;
    }

    .log-info { color: #60a5fa; }
    .log-success { color: #34d399; }
    .log-warn { color: #fbbf24; }
    .log-error { color: #f87171; }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      .sidebar {
        grid-column: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¬ æ··åˆæ’­æ”¾å™¨ç¤ºä¾‹</h1>
      <p class="subtitle">
        <span class="badge badge-auth">âœ“ Thunderé‰´æƒ</span>
        <span class="badge badge-decrypt">âœ“ ThunderStoneè§£å¯†</span>
        <span class="badge badge-hardware">âœ“ libmediaç¡¬è§£ç </span>
      </p>
    </div>

    <div class="main-grid">
      <!-- å·¦ä¾§ï¼šæ’­æ”¾å™¨ -->
      <div class="video-card card">
        <div class="video-container">
          <div id="videoContainer"></div>
        </div>

        <div class="controls">
          <div class="input-group">
            <label>ğŸ“¹ è§†é¢‘åœ°å€</label>
            <input 
              type="text" 
              id="videoUrl" 
              placeholder="è¾“å…¥ThunderStoneåŠ å¯†è§†é¢‘URL..."
              value="https://qnktv.ktvdaren.com/tempmls/convert/20250407/4115794.ts"
            />
          </div>

          <div class="samples">
            <div class="sample-title">ğŸ” æµ‹è¯•è§†é¢‘ï¼ˆThunderStoneåŠ å¯†ï¼‰</div>
            <div class="sample-item" onclick="fillUrl('https://qnktv.ktvdaren.com/tempmls/convert/20250407/4115794.ts')">
              ğŸµ è¿½æ¢¦çš„å¿ƒ (åŠ å¯†TS)
            </div>
            <div class="sample-item" onclick="fillUrl('https://qnktv.ktvdaren.com/tempmls/convert/20250407/4116492.ts')">
              ğŸµ ä¸œåŒ—è¯ (åŠ å¯†TS)
            </div>
          </div>

          <div class="button-group">
            <button id="initBtn" class="btn-primary" onclick="initSystem()">
              ğŸš€ åˆå§‹åŒ–ç³»ç»Ÿ
            </button>
            <button id="loadBtn" class="btn-success" onclick="loadAndPlay()" disabled>
              â–¶ï¸ åŠ è½½å¹¶æ’­æ”¾
            </button>
            <button id="stopBtn" class="btn-danger" onclick="stopPlayback()" disabled>
              â¹ï¸ åœæ­¢
            </button>
          </div>
        </div>

        <!-- WASM Packetæµ‹è¯•åŒºåŸŸ -->
        <div class="card">
          <div class="card-title">ğŸ”¬ WASM Packetæµ‹è¯• (æ–¹æ¡ˆBéªŒè¯)</div>
          <div class="card-content">
            <div style="margin-bottom: 12px;">
              <button class="btn-info" onclick="testWASMPackets()" id="wasmTestBtn" disabled>
                ğŸ§ª æµ‹è¯•WASM Packetè¾“å‡º
              </button>
              <button class="btn-secondary" onclick="clearWASMLog()">
                ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
              </button>
            </div>
            <div id="wasmPacketLog" style="background: #1e1e1e; border: 1px solid #3c3c3c; padding: 12px; height: 200px; overflow-y: auto; font-size: 12px; font-family: monospace; color: #d4d4d4;"></div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šä¿¡æ¯é¢æ¿ -->
      <div class="sidebar">
        <div class="info-panel">
          <div class="panel-title">ğŸ“Š ç³»ç»ŸçŠ¶æ€</div>
          <div class="status-grid">
            <div class="status-item">
              <span class="status-label">é‰´æƒçŠ¶æ€</span>
              <span class="status-value status-pending" id="authStatus">æœªåˆå§‹åŒ–</span>
            </div>
            <div class="status-item">
              <span class="status-label">WASMæ¨¡å—</span>
              <span class="status-value status-pending" id="wasmStatus">æœªåŠ è½½</span>
            </div>
            <div class="status-item">
              <span class="status-label">æ’­æ”¾å™¨</span>
              <span class="status-value status-pending" id="playerStatus">æœªåˆå§‹åŒ–</span>
            </div>
            <div class="status-item">
              <span class="status-label">è§£å¯†æ¨¡å¼</span>
              <span class="status-value status-info" id="decryptMode">-</span>
            </div>
            <div class="status-item">
              <span class="status-label">è§£ç æ–¹å¼</span>
              <span class="status-value status-info" id="decodeMode">-</span>
            </div>
          </div>
        </div>

        <div class="log-panel">
          <div class="log-title">ğŸ“ è¿è¡Œæ—¥å¿—</div>
          <div id="logContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¾èµ–åŠ è½½ -->

  <!-- 0. Thunder HTTP Bridge (WASMé‰´æƒéœ€è¦) -->
  <script>
    // Thunder Player HTTPæ¡¥æ¥
    window.ThunderPlayerBridge = {
      async httpPostBinary(urlPtr, data, callbackId) {
        try {
          // å…¼å®¹æ€§æ£€æŸ¥ï¼šç¡®ä¿Moduleå·²åŠ è½½
          if (typeof Module === 'undefined') {
            console.error('âŒ [HTTP Bridge] ModuleæœªåŠ è½½')
            return
          }

          // ä»WASMå†…å­˜è¯»å–URLå­—ç¬¦ä¸²ï¼ˆurlPtræ˜¯Cå­—ç¬¦ä¸²æŒ‡é’ˆï¼‰
          const url = Module.UTF8ToString(urlPtr)
          const dataSize = data.length

          console.log('ğŸŒ [HTTP Bridge] POSTè¯·æ±‚:', url, ', æ•°æ®å¤§å°:', dataSize, 'bytes')

          // æ£€æŸ¥æ˜¯å¦æ˜¯Thunderé‰´æƒURL
          let requestUrl = url
          if (url === '/api/wauth/init/v2') {
            // æŒ‰ç…§ä¼˜å…ˆçº§é€‰æ‹©é‰´æƒæœåŠ¡å™¨ï¼š
            // 1. æœ€é«˜ä¼˜å…ˆçº§ï¼šinitSDKä¼ å…¥çš„authServer
            // 2. ç¬¬äºŒä¼˜å…ˆçº§ï¼šthunder-config.jsé…ç½®
            // 3. æœ€ä½ä¼˜å…ˆçº§ï¼šSDKé»˜è®¤æœåŠ¡å™¨
            let authServer = 'https://wauth.music.xunlei.com' // é»˜è®¤

            if (globalThis.thunderPlayerAuthServer) {
              authServer = globalThis.thunderPlayerAuthServer
              console.log(`  ä½¿ç”¨initSDKä¼ å…¥çš„è®¤è¯æœåŠ¡å™¨: ${authServer}`)
            } else if (window.THUNDER_CONFIG?.authServer) {
              authServer = window.THUNDER_CONFIG.authServer
              console.log(`  ä½¿ç”¨thunder-config.jsé…ç½®çš„è®¤è¯æœåŠ¡å™¨: ${authServer}`)
            } else {
              console.log(`  ä½¿ç”¨SDKé»˜è®¤è®¤è¯æœåŠ¡å™¨: ${authServer}`)
            }

            requestUrl = authServer + '/wauth/init/v2'
            console.log(`  é‡å†™URL: ${url} â†’ ${requestUrl}`)
          }

          // å‘é€HTTP POSTè¯·æ±‚
          const startTime = performance.now()
          const response = await fetch(requestUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'text/plain'  // é¿å…CORSé¢„æ£€
            },
            body: data,
            mode: 'cors'
          })

          const responseTime = Math.round(performance.now() - startTime)

          if (!response.ok) {
            console.error(`âŒ [HTTP Bridge] è¯·æ±‚å¤±è´¥: ${response.status}`)
            // è°ƒç”¨WASMå›è°ƒï¼Œstatus = -1è¡¨ç¤ºå¤±è´¥
            Module._http_response_handler(0, -1, callbackId)
            return
          }

          // è¯»å–å“åº”æ•°æ®ï¼ˆäºŒè¿›åˆ¶ï¼‰
          const arrayBuffer = await response.arrayBuffer()
          const binaryData = new Uint8Array(arrayBuffer)
          console.log(`âœ… [HTTP Bridge] è¯·æ±‚æˆåŠŸ: ${response.status}, è€—æ—¶: ${responseTime}ms, å“åº”å¤§å°: ${binaryData.length} bytes`)

          // å°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºbase64å­—ç¬¦ä¸²ï¼ˆé¿å…äºŒè¿›åˆ¶æ•°æ®åœ¨å­—ç¬¦ä¸²ä¼ è¾“ä¸­ä¸¢å¤±ï¼‰
          let binary = ''
          for (let i = 0; i < binaryData.length; i++) {
            binary += String.fromCharCode(binaryData[i])
          }
          const base64String = btoa(binary)
          const responseText = 'BASE64:' + base64String

          console.log(`  - åŸå§‹äºŒè¿›åˆ¶: ${binaryData.length} bytes`)
          console.log(`  - Base64ç¼–ç : ${base64String.length} chars`)
          console.log(`  - å‰16å­—èŠ‚: ${Array.from(binaryData.slice(0, 16)).map(b => b.toString(16).padStart(2, '0')).join(' ')}`)

          // å°†å“åº”æ•°æ®ä¼ å›WASMï¼ˆä½¿ç”¨æ ‡å‡†Emscripten APIï¼‰
          const responseLen = lengthBytesUTF8(responseText) + 1
          const responsePtr = Module._malloc(responseLen)
          Module.stringToUTF8(responseText, responsePtr, responseLen)

          Module._http_response_handler(responsePtr, response.status, callbackId)
          Module._free(responsePtr)

        } catch (error) {
          console.error('âŒ [HTTP Bridge] è¯·æ±‚å¼‚å¸¸:', error)
          Module._http_response_handler(0, -1, callbackId)
        }
      },

      async httpPost(urlPtr, dataPtr, callbackId) {
        // æ–‡æœ¬POSTè¯·æ±‚ï¼ˆå°†JSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼‰
        // ä»WASMå†…å­˜è¯»å–å­—ç¬¦ä¸²
        const text = Module.UTF8ToString(dataPtr)
        const data = new TextEncoder().encode(text)
        await this.httpPostBinary(urlPtr, data, callbackId)
      }
    }

    console.log('âœ… Thunder HTTP Bridgeå·²åŠ è½½')
  </script>

  <!-- 0. Thunderé…ç½®æ–‡ä»¶ï¼ˆé‰´æƒæœåŠ¡å™¨åœ°å€ï¼‰ -->
  <script src="./thunder-config.js"></script>

  <!-- 1. ThunderStone WASMæ¨¡å— (æ–°ç‰ˆæœ¬ï¼šæ”¯æŒpacketè¾“å‡º) -->
  <script src="./thunder_module.js"></script>
  
  <!-- 2. Thunder Player SDKï¼ˆç”¨äºé‰´æƒï¼‰ -->
  <script src="../../.temp/thunderwebplayer/packages/webplayer-vue/public/js/common.js"></script>
  <script src="../../.temp/thunderwebplayer/packages/webplayer-vue/public/js/pcm-player.js"></script>
  <script src="../../.temp/thunderwebplayer/packages/webplayer-vue/public/js/webgl.js"></script>
  <script src="../../.temp/thunderwebplayer/packages/webplayer-vue/public/js/player.js"></script>
  
  <!-- 3. libmedia AVPlayer -->
  <script src="../../dist/avplayer/avplayer.js"></script>

  <!-- 4. æ··åˆæ’­æ”¾å™¨ç»„ä»¶ -->
  <script src="./ThunderAuthAdapter.js"></script>
  <script src="./HybridThunderStoneIOLoader.js"></script>
  <script src="./ThunderWASMBridge.js"></script>

  <script>
    // ============================================
    // å…¨å±€çŠ¶æ€
    // ============================================
    const state = {
      authAdapter: null,
      player: null,
      currentLoader: null,
      isInitialized: false
    }

    // ============================================
    // å·¥å…·å‡½æ•°
    // ============================================
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString()
      const entry = document.createElement('div')
      entry.className = `log-entry log-${type}`
      entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`
      
      const container = document.getElementById('logContainer')
      container.appendChild(entry)
      container.scrollTop = container.scrollHeight
      
      console.log(`[${type.toUpperCase()}]`, message)
    }

    function updateStatus(id, text, className) {
      const el = document.getElementById(id)
      el.textContent = text
      el.className = `status-value ${className}`
    }

    function fillUrl(url) {
      document.getElementById('videoUrl').value = url
      log(`URLå·²å¡«å……: ${url.split('/').pop()}`, 'info')
    }

    // ============================================
    // æ­¥éª¤1ï¼šåˆå§‹åŒ–ç³»ç»Ÿ
    // ============================================
    async function initSystem() {
      try {
        log('â•'.repeat(50), 'info')
        log('ğŸš€ å¼€å§‹åˆå§‹åŒ–æ··åˆæ’­æ”¾å™¨ç³»ç»Ÿ...', 'info')
        
        document.getElementById('initBtn').disabled = true

        // 1. æ£€æŸ¥ä¾èµ–
        log('ğŸ“¦ æ£€æŸ¥ä¾èµ–åŠ è½½çŠ¶æ€...', 'info')
        
        // Emscriptenå¯¼å‡ºçš„å…¨å±€å˜é‡æ˜¯ Moduleï¼Œä¸æ˜¯ ThunderModule
        if (typeof Module === 'undefined') {
          throw new Error('ThunderStone WASMæ¨¡å—æœªåŠ è½½ï¼ˆå…¨å±€å˜é‡ Module ä¸å­˜åœ¨ï¼‰')
        }
        if (!Module._tsInitDecrypt) {
          throw new Error('ThunderStone WASMæ¨¡å—ç¼ºå°‘è§£å¯†å‡½æ•°')
        }
        log('  âœ“ ThunderStone WASM', 'success')
        updateStatus('wasmStatus', 'å·²åŠ è½½', 'status-success')
        
        // ä¿å­˜åˆ°å…¨å±€ä»¥ä¾¿å…¶ä»–ä»£ç ä½¿ç”¨
        window.ThunderModule = Module

        if (typeof window.Player === 'undefined') {
          throw new Error('Thunder Player SDKæœªåŠ è½½')
        }
        log('  âœ“ Thunder Player SDK', 'success')

        if (typeof AVPlayer === 'undefined') {
          throw new Error('libmedia AVPlayeræœªåŠ è½½')
        }
        log('  âœ“ libmedia AVPlayer', 'success')

        // 2. åˆå§‹åŒ–Thunderé‰´æƒ
        log('ğŸ” åˆå§‹åŒ–Thunderé‰´æƒ...', 'info')
        updateStatus('authStatus', 'åˆå§‹åŒ–ä¸­...', 'status-pending')

        state.authAdapter = new ThunderAuthAdapter()
        const authResult = await state.authAdapter.init({
          appid: 'b72d8f35e1c7abde45f69c82d7314590',
          uid: `libmedia-${Date.now()}`,
          sdk_sn: 'demo-sdk-sn-001'
        })

        if (!authResult) {
          throw new Error('Thunderé‰´æƒå¤±è´¥')
        }

        log('  âœ“ Thunderé‰´æƒæˆåŠŸ', 'success')
        updateStatus('authStatus', 'å·²é‰´æƒ', 'status-success')

        // 3. åˆ›å»ºlibmediaæ’­æ”¾å™¨
        log('ğŸ¬ åˆ›å»ºlibmediaæ’­æ”¾å™¨...', 'info')
        updateStatus('playerStatus', 'åˆ›å»ºä¸­...', 'status-pending')

        state.player = new AVPlayer({
          container: document.getElementById('videoContainer'),
          enableWorker: true, // å¯ç”¨Workerå¤šçº¿ç¨‹
          enableWebCodecs: true // å¯ç”¨ç¡¬è§£ç 
        })
        
        // ç›‘å¬æ’­æ”¾å™¨äº‹ä»¶
        state.player.on('loaded', () => {
          log('âœ… [æ’­æ”¾å™¨] è§†é¢‘åŠ è½½æˆåŠŸ', 'success')
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] loaded')
        })
        
        state.player.on('playing', () => {
          log('â–¶ï¸ [æ’­æ”¾å™¨] å¼€å§‹æ’­æ”¾', 'success')
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] playing')
        })
        
        state.player.on('paused', () => {
          log('â¸ï¸ [æ’­æ”¾å™¨] å·²æš‚åœ', 'info')
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] paused')
        })
        
        state.player.on('error', (error) => {
          log(`âŒ [æ’­æ”¾å™¨] æ’­æ”¾å™¨é”™è¯¯: ${error.message || error}`, 'error')
          console.error('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] error:', error)
          console.error('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] error.stack:', error.stack)
        })
              
        state.player.on('timeupdate', (time) => {
          console.log(`â±ï¸ [æ’­æ”¾å™¨äº‹ä»¶] timeupdate: ${time.toFixed(2)}s`)
        })
              
        state.player.on('seeking', () => {
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] seeking')
        })
              
        state.player.on('seeked', () => {
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] seeked')
        })
              
        state.player.on('ended', () => {
          log('ğŸ [æ’­æ”¾å™¨] æ’­æ”¾ç»“æŸ', 'info')
          console.log('ğŸ¬ [æ’­æ”¾å™¨äº‹ä»¶] ended')
        })

        log('  âœ“ libmediaæ’­æ”¾å™¨åˆ›å»ºæˆåŠŸ', 'success')
        updateStatus('playerStatus', 'å°±ç»ª', 'status-success')
        updateStatus('decodeMode', 'WebCodecsç¡¬è§£', 'status-success')

        // 4. å®Œæˆåˆå§‹åŒ–
        state.isInitialized = true
        document.getElementById('loadBtn').disabled = false
        document.getElementById('wasmTestBtn').disabled = false

        log('â•'.repeat(50), 'info')
        log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼', 'success')
        log('ğŸ’¡ å½“å‰æ–¹æ¡ˆï¼šThunderé‰´æƒ + WASMè§£å¯†demux + libmediaç¡¬è§£', 'info')
        log('ğŸ”’ å®‰å…¨ä¿è¯ï¼šæ˜æ–‡æ•°æ®ä¸æš´éœ²åˆ°JSå±‚ï¼ˆä»…packetä¼ é€’ï¼‰', 'info')
        log('â•'.repeat(50), 'info')

      } catch (error) {
        log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error')
        updateStatus('authStatus', 'å¤±è´¥', 'status-error')
        updateStatus('playerStatus', 'å¤±è´¥', 'status-error')
        document.getElementById('initBtn').disabled = false
      }
    }

    // ============================================
    // æ­¥éª¤2ï¼šåŠ è½½å¹¶æ’­æ”¾è§†é¢‘
    // ============================================
    async function loadAndPlay() {
      if (!state.isInitialized) {
        log('âš ï¸ è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warn')
        return
      }

      try {
        const url = document.getElementById('videoUrl').value.trim()
        if (!url) {
          log('âš ï¸ è¯·è¾“å…¥è§†é¢‘URL', 'warn')
          return
        }

        log('â•'.repeat(50), 'info')
        log(`ğŸµ å¼€å§‹åŠ è½½è§†é¢‘: ${url.split('/').pop()}`, 'info')

        document.getElementById('loadBtn').disabled = true
        document.getElementById('stopBtn').disabled = false

        // 1. åˆ›å»ºThunderWASMBridge (æ–¹æ¡ˆBï¼šWASM demux + libmediaç¡¬è§£)
        log('ğŸ”§ åˆ›å»ºThunderWASMBridge...', 'info')
        log('  ä½¿ç”¨WASM demuxerè¿›è¡ŒThunderè§£å¯†å’Œdemux', 'info')
        log('  Packetæ•°æ®é€šè¿‡å›è°ƒä¼ é€’åˆ°libmedia', 'info')

        state.currentLoader = new ThunderWASMBridge({
          url: url,
          thunderModule: window.ThunderModule || Module,
          debug: true  // å¼€å¯è°ƒè¯•æ—¥å¿—
        })

        // 2. åŠ è½½è§†é¢‘
        log('ğŸ“¥ [æ’­æ”¾å™¨] åŠ è½½è§†é¢‘åˆ°æ’­æ”¾å™¨...', 'info')
        console.log('ğŸš€ [æ’­æ”¾å™¨] è°ƒç”¨ player.load(ThunderWASMBridge)')
        console.log('ğŸš€ [æ’­æ”¾å™¨] IOLoader:', state.currentLoader)

        await state.currentLoader.open()  // å…ˆæ‰“å¼€IOLoader

        // âš ï¸ TODO: libmediaéœ€è¦æ”¯æŒä»packetæµåŠ è½½
        // å½“å‰libmediaæœŸæœ›çš„æ˜¯å®Œæ•´TSæµï¼Œéœ€è¦é€‚é…
        log('âš ï¸ æ³¨æ„ï¼šlibmediaéœ€è¦é€‚é…packetæµè¾“å…¥', 'warn')
        log('   å½“å‰æ–¹æ¡ˆï¼šWASMè¾“å‡ºpacket â†’ ä¸´æ—¶ç¼“å­˜ â†’ æŒ‰éœ€read', 'info')

        // await state.player.load(state.currentLoader, {
        //   isLive: false,
        //   enableHardware: true
        // })
        
        console.log('âœ… [æ’­æ”¾å™¨] load()è¿”å›æˆåŠŸ')
        log('  âœ“ è§†é¢‘åŠ è½½æˆåŠŸ', 'success')

        // 3. å¼€å§‹æ’­æ”¾
        log('â–¶ï¸ å¼€å§‹æ’­æ”¾...', 'info')
        await state.player.play()

        // 4. æ›´æ–°çŠ¶æ€
        const decryptMode = state.currentLoader.isEncrypted ? 'âœ“ ThunderStoneè§£å¯†' : 'â—‹ æ˜æ–‡'
        updateStatus('decryptMode', decryptMode, state.currentLoader.isEncrypted ? 'status-success' : 'status-info')

        log('â•'.repeat(50), 'info')
        log('âœ… æ’­æ”¾æˆåŠŸï¼', 'success')
        log('â•'.repeat(50), 'info')

      } catch (error) {
        log(`âŒ æ’­æ”¾å¤±è´¥: ${error.message}`, 'error')
        console.error('è¯¦ç»†é”™è¯¯:', error)
        document.getElementById('loadBtn').disabled = false
        document.getElementById('stopBtn').disabled = true
      }
    }

    // ============================================
    // æ­¥éª¤3ï¼šåœæ­¢æ’­æ”¾
    // ============================================
    async function stopPlayback() {
      try {
        log('â¹ï¸ åœæ­¢æ’­æ”¾...', 'info')

        if (state.player) {
          await state.player.pause()
        }

        document.getElementById('loadBtn').disabled = false
        document.getElementById('stopBtn').disabled = true

        log('âœ“ å·²åœæ­¢', 'success')
      } catch (error) {
        log(`âŒ åœæ­¢å¤±è´¥: ${error.message}`, 'error')
      }
    }

    // ============================================
    // WASM Packetæµ‹è¯•åŠŸèƒ½
    // ============================================
    let wasmPacketCallback = null
    let wasmPacketCount = 0

    function wasmLog(message, type = 'info') {
      const logDiv = document.getElementById('wasmPacketLog')
      const time = new Date().toLocaleTimeString()
      const color = type === 'success' ? '#4ec9b0' : type === 'error' ? '#f48771' : type === 'warning' ? '#dcdcaa' : '#d4d4d4'
      logDiv.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`
      logDiv.scrollTop = logDiv.scrollHeight
    }

    function clearWASMLog() {
      document.getElementById('wasmPacketLog').innerHTML = ''
    }

    async function testWASMPackets() {
      wasmLog('ğŸ”¬ å¼€å§‹WASM Packetæµ‹è¯•...', 'warning')

      try {
        if (!state.isInitialized) {
          wasmLog('âŒ è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿï¼ˆThunderé‰´æƒï¼‰', 'error')
          return
        }

        const url = document.getElementById('videoUrl').value.trim()
        if (!url) {
          wasmLog('âŒ è¯·å…ˆè¾“å…¥è§†é¢‘URL', 'error')
          return
        }

        // 0. æ£€æŸ¥Thunderé‰´æƒçŠ¶æ€ï¼ˆæš‚æ—¶è·³è¿‡WASMé‰´æƒæ£€æŸ¥ï¼‰
        wasmLog('0ï¸âƒ£ æ£€æŸ¥Thunderé‰´æƒçŠ¶æ€...', 'info')
        const authStatus = Module._get_auth_status_wrapper()
        if (authStatus !== 1) {
          wasmLog(`   âš ï¸ WASMé‰´æƒæœªå®Œæˆï¼ˆçŠ¶æ€: ${authStatus}ï¼‰ï¼Œä½†ç»§ç»­æµ‹è¯•...`, 'warning')
          wasmLog('   æ³¨æ„ï¼šå¦‚æœæ˜¯åŠ å¯†æ–‡ä»¶ï¼Œè§£å¯†å¯èƒ½å¤±è´¥', 'warning')
        } else {
          wasmLog('   âœ… Thunderé‰´æƒæˆåŠŸ', 'success')
        }

        // 1. åˆå§‹åŒ–decoderï¼ˆå¿…é¡»å…ˆåˆå§‹åŒ–å†è®¾ç½®å›è°ƒï¼‰
        wasmLog('1ï¸âƒ£ åˆå§‹åŒ–decoder...', 'info')
        const fileSize = 100 * 1024 * 1024
        const initRet = Module._initDecoder(fileSize, 0)
        if (initRet !== 0) {
          wasmLog(`   âŒ åˆå§‹åŒ–å¤±è´¥: ${initRet}`, 'error')
          return
        }
        wasmLog('   âœ… Decoderåˆå§‹åŒ–æˆåŠŸ', 'success')

        // 2. è®¾ç½®packetå›è°ƒ
        wasmLog('2ï¸âƒ£ è®¾ç½®packetå›è°ƒ...', 'info')
        wasmPacketCount = 0
        wasmPacketCallback = Module.addFunction(
          function(stream_type, dataPtr, size, pts, dts, flags) {
            wasmPacketCount++
            const streamName = stream_type === 0 ? 'VIDEO' : 'AUDIO'
            const isKeyframe = (flags & 1) !== 0

            wasmLog(`ğŸ“¦ Packet #${wasmPacketCount}: ${streamName} ${size}B, pts=${pts}, keyframe=${isKeyframe}`, 'success')

            // è¯»å–å‰16å­—èŠ‚
            if (size >= 16) {
              const data = new Uint8Array(Module.HEAPU8.buffer, dataPtr, 16)
              const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' ')
              wasmLog(`   æ•°æ®: ${hex}`, 'info')

              // H264 NALåˆ†æ
              if (stream_type === 0 && size >= 5) {
                if (data[0] === 0 && data[1] === 0 && data[2] === 0 && data[3] === 1) {
                  const nalType = data[4] & 0x1F
                  const nalNames = { 1: 'Non-IDR', 5: 'IDR', 6: 'SEI', 7: 'SPS', 8: 'PPS', 9: 'AU delimiter' }
                  wasmLog(`   H264 NAL: ${nalType} (${nalNames[nalType] || 'å…¶ä»–'})`, 'success')
                }
              }
            }
          },
          'viiiiii'  // v=void, 6ä¸ªint: stream_type, dataPtr, size, pts, dts, flags
        )
        Module._js_setPacketCallback(wasmPacketCallback)
        wasmLog('   âœ… å›è°ƒè®¾ç½®æˆåŠŸ', 'success')

        // 3. Fetchè§†é¢‘æ•°æ®
        wasmLog('3ï¸âƒ£ ä¸‹è½½è§†é¢‘æ•°æ® (å‰1MB)...', 'info')
        const response = await fetch(url, {
          headers: { 'Range': 'bytes=0-1048575' }
        })
        if (!response.ok) {
          wasmLog(`   âŒ ä¸‹è½½å¤±è´¥: ${response.status}`, 'error')
          return
        }
        const videoData = new Uint8Array(await response.arrayBuffer())
        wasmLog(`   âœ… ä¸‹è½½å®Œæˆ: ${videoData.length} bytes`, 'success')

        // 4. Send dataåˆ°WASM (ä¿®å¤ï¼šé¦–å—å¿…é¡»è¶³å¤Ÿå¤§ä»¥è§¦å‘demux)
        wasmLog('4ï¸âƒ£ å‘é€æ•°æ®åˆ°WASM...', 'info')

        // âœ… å…³é”®ä¿®å¤ï¼šé¦–å—å¿…é¡»æ˜¯ 512å­—èŠ‚header + 8KBå€æ•°çš„æ•°æ®
        // Thunderè§£å¯†è¦æ±‚ï¼šæ•°æ®å¤§å°å¿…é¡»æ˜¯8192çš„æ•´æ•°å€
        const HEADER_SIZE = 512
        const CHUNK_SIZE = 8192
        const DATA_CHUNKS = 64  // 64ä¸ª8KBå— = 512KBæ•°æ®
        const FIRST_CHUNK_SIZE = HEADER_SIZE + (DATA_CHUNKS * CHUNK_SIZE)  // 512 + 524288 = 524800å­—èŠ‚
        const firstChunk = videoData.slice(0, Math.min(FIRST_CHUNK_SIZE, videoData.length))

        const firstPtr = Module._malloc(firstChunk.length)
        Module.HEAPU8.set(firstChunk, firstPtr)
        const firstRet = Module._sendData(0, firstPtr, firstChunk.length, 0) // type=0: header (é¦–å—)
        Module._free(firstPtr)

        if (firstRet < 0) {
          wasmLog(`   âŒ å‘é€é¦–å—å¤±è´¥: ${firstRet}`, 'error')
          return
        }
        wasmLog(`   âœ… é¦–å—å‘é€æˆåŠŸ (${firstChunk.length} bytes)`, 'success')

        // 5. âœ… ä¿®å¤ï¼šå‘é€é¦–å—åç«‹å³æ‰“å¼€decoder
        wasmLog('5ï¸âƒ£ æ‰“å¼€decoder (FFmpeg demux)...', 'info')
        const openRet = Module._openDecoder(0, 0, 0, 0, 0, 0)
        if (openRet !== 0) {
          wasmLog(`   âŒ openDecoderå¤±è´¥: ${openRet}`, 'error')
          return
        }
        wasmLog('   âœ… Decoderæ‰“å¼€æˆåŠŸ', 'success')

        // âœ… å…³é”®ä¿®å¤ï¼šopenDecoderåéœ€è¦é‡æ–°è®¾ç½®packetå›è°ƒ
        // å› ä¸ºopenDecoderå¯èƒ½ä¼šé‡æ–°åˆå§‹åŒ–æŸäº›decoderå­—æ®µ
        Module._js_setPacketCallback(wasmPacketCallback)
        wasmLog('   âœ… Packetå›è°ƒå·²é‡æ–°è®¾ç½®', 'success')

        // 6. å‘é€å‰©ä½™æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
        if (videoData.length > FIRST_CHUNK_SIZE) {
          wasmLog('6ï¸âƒ£ å‘é€å‰©ä½™æ•°æ®...', 'info')
          const remaining = videoData.slice(FIRST_CHUNK_SIZE)
          const remainPtr = Module._malloc(remaining.length)
          Module.HEAPU8.set(remaining, remainPtr)
          const remainRet = Module._sendData(FIRST_CHUNK_SIZE, remainPtr, remaining.length, 1) // type=1: stream
          Module._free(remainPtr)

          if (remainRet < 0) {
            wasmLog(`   âš ï¸ å‰©ä½™æ•°æ®å‘é€å¤±è´¥: ${remainRet}`, 'warning')
          } else {
            wasmLog(`   âœ… å‰©ä½™æ•°æ®å‘é€æˆåŠŸ (${remaining.length} bytes)`, 'success')
          }
        }

        // 7. è·å–stream metadata
        wasmLog('7ï¸âƒ£ è·å–stream metadata...', 'info')
        const videoIdx = Module._js_getVideoStreamIndex()
        const audioIdx = Module._js_getAudioStreamIndex()
        wasmLog(`   Video Stream: ${videoIdx}, Audio Stream: ${audioIdx}`, 'info')

        if (videoIdx >= 0) {
          const codecId = Module._js_getVideoCodecId()
          const width = Module._js_getVideoWidth()
          const height = Module._js_getVideoHeight()
          wasmLog(`   Video: CodecID=${codecId}, ${width}x${height}`, 'success')
        }

        if (audioIdx >= 0) {
          const audioCodecId = Module._js_getAudioCodecId()
          const sampleRate = Module._js_getAudioSampleRate()
          const channels = Module._js_getAudioChannels()
          wasmLog(`   Audio: CodecID=${audioCodecId}, ${sampleRate}Hz, ${channels}ch`, 'success')
        }

        // 8. è¯»å–packets
        wasmLog('8ï¸âƒ£ è¯»å–å‰10ä¸ªpackets...', 'warning')
        let successCount = 0
        for (let i = 0; i < 10; i++) {
          const ret = Module._js_readOnePacket()
          if (ret === 0) {
            successCount++
          } else {
            wasmLog(`   âš ï¸ readOnePacketè¿”å›: ${ret}`, 'warning')
            break
          }
        }

        wasmLog(`âœ… æµ‹è¯•å®Œæˆï¼æˆåŠŸè¯»å– ${successCount} ä¸ªpackets`, 'success')
        wasmLog(`ğŸ“Š æ€»å…±è¾“å‡º ${wasmPacketCount} ä¸ªpacketsåˆ°å›è°ƒ`, 'success')

      } catch (error) {
        wasmLog(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
        console.error(error)
      }
    }

    // ============================================
    // é¡µé¢åŠ è½½å®Œæˆ
    // ============================================
    window.addEventListener('DOMContentLoaded', () => {
      log('ğŸŒ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å°±ç»ª', 'info')
      log('ğŸ“– è¯·ç‚¹å‡»"åˆå§‹åŒ–ç³»ç»Ÿ"å¼€å§‹', 'info')
    })
  </script>
</body>
</html>
