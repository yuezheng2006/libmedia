# æ··åˆæ’­æ”¾å™¨ä½¿ç”¨æŒ‡å—

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœ¬åœ°æœåŠ¡

```bash
cd /Users/vincentyang/Documents/Github/libmedia/libmedia
pnpm run server
```

### 2. è®¿é—®æµ‹è¯•é¡µé¢

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š
```
http://localhost:8000/examples/hybrid-thunder-player/
```

### 3. æ“ä½œæ­¥éª¤

1. **ç‚¹å‡»"åˆå§‹åŒ–ç³»ç»Ÿ"** â†’ å®ŒæˆThunderé‰´æƒ + libmediaæ’­æ”¾å™¨åˆå§‹åŒ–
2. **ç‚¹å‡»"åŠ è½½å¹¶æ’­æ”¾"** â†’ å¼€å§‹æ’­æ”¾åŠ å¯†è§†é¢‘
3. **è§‚å¯Ÿæ—¥å¿—é¢æ¿** â†’ æŸ¥çœ‹è¯¦ç»†çš„æ‰§è¡Œæµç¨‹

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### ç›¸æ¯”pure Thunderæ–¹æ¡ˆ
âœ… **ç¡¬è§£ç æ€§èƒ½**ï¼šä½¿ç”¨WebCodecsä»£æ›¿è½¯è§£ï¼Œæ€§èƒ½æå‡3-5å€  
âœ… **æ›´ä½CPUå ç”¨**ï¼šç¡¬ä»¶åŠ é€Ÿè§£ç ï¼ŒCPUå ç”¨é™ä½70%  
âœ… **æ›´å¥½çš„å…¼å®¹æ€§**ï¼šlibmediaæˆç†Ÿçš„è§£å°è£…èƒ½åŠ›  

### ç›¸æ¯”pure libmediaæ–¹æ¡ˆ
âœ… **å®Œæ•´çš„é‰´æƒ**ï¼šå¤ç”¨Thunder SDKçš„æˆç†Ÿé‰´æƒæœºåˆ¶  
âœ… **ThunderStoneè§£å¯†**ï¼šå®Œæ•´æ”¯æŒåŠ å¯†è§†é¢‘  
âœ… **é›¶ä¿®æ”¹é›†æˆ**ï¼šä¸éœ€è¦ä¿®æ”¹libmediaæºç   

---

## ğŸ”§ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æ“ä½œï¼ˆç‚¹å‡»æ’­æ”¾ï¼‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ThunderAuthAdapterï¼ˆé‰´æƒå±‚ï¼‰                    â”‚
â”‚  - Thunder SDKåˆå§‹åŒ–                             â”‚
â”‚  - appid/uid/sdk_sné‰´æƒ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HybridThunderStoneIOLoaderï¼ˆIOå±‚ï¼‰             â”‚
â”‚  - ç»§æ‰¿CustomIOLoader                            â”‚
â”‚  - ç½‘ç»œè¯·æ±‚ â†’ ThunderStoneè§£å¯† â†’ è¿”å›æ•°æ®        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  libmedia AVPlayerï¼ˆæ’­æ”¾å±‚ï¼‰                     â”‚
â”‚  - avformatè§£å°è£…TS                              â”‚
â”‚  - WebCodecsç¡¬è§£ç H.264/AAC                      â”‚
â”‚  - æ¸²æŸ“åˆ°Canvas                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®æµè¯¦è§£

### å®Œæ•´æ•°æ®æµå‘

```
1. ç”¨æˆ·ç‚¹å‡»æ’­æ”¾
   â†“
2. ThunderAuthAdapter é‰´æƒéªŒè¯
   â†“
3. HybridThunderStoneIOLoader.open()
   - Fetchè¯·æ±‚è§†é¢‘URL
   - è¯»å–å‰512å­—èŠ‚
   - _tsCheckDecrypt()æ£€æµ‹åŠ å¯†
   â†“
4. HybridThunderStoneIOLoader.read()
   - è¯»å–ç½‘ç»œæ•°æ®
   - å¦‚æœåŠ å¯†ï¼š_tsDataDecrypt()è§£å¯†
   - è¿”å›æ˜æ–‡æ•°æ®ç»™libmedia
   â†“
5. libmedia AVPlayerå¤„ç†
   - avformatè§£å°è£…TS
   - æå–H.264è§†é¢‘æµ + AACéŸ³é¢‘æµ
   â†“
6. WebCodecsç¡¬è§£ç 
   - VideoDecoderè§£ç H.264
   - AudioDecoderè§£ç AAC
   â†“
7. æ¸²æŸ“è¾“å‡º
   - Canvasæ˜¾ç¤ºè§†é¢‘
   - AudioContextæ’­æ”¾éŸ³é¢‘
```

### å…³é”®è§£å¯†æµç¨‹

```javascript
// 1. æ£€æµ‹åŠ å¯†ï¼ˆå‰512å­—èŠ‚ï¼‰
const checkResult = thunderModule._tsCheckDecrypt(handle, buffer, 512)
// checkResult === -3 â†’ åŠ å¯†æµ
// checkResult === 0  â†’ æ˜æ–‡æµ

// 2. æµå¼è§£å¯†ï¼ˆ8KBå—ï¼‰
while (hasData) {
  const chunk = readChunk(8192)
  thunderModule._tsDataDecrypt(handle, chunk, 8192, offset)
  // offsetä»512å¼€å§‹ï¼ˆè·³è¿‡å¤´éƒ¨ï¼‰
  feedToPlayer(decryptedChunk)
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### é¢„ç½®æµ‹è¯•URL

1. **è¿½æ¢¦çš„å¿ƒ**ï¼ˆåŠ å¯†TSï¼‰
   ```
   https://qnktv.ktvdaren.com/tempmls/convert/20250407/4115794.ts
   ```

2. **ä¸œåŒ—è¯**ï¼ˆåŠ å¯†TSï¼‰
   ```
   https://qnktv.ktvdaren.com/tempmls/convert/20250407/4116492.ts
   ```

### éªŒè¯æ£€æŸ¥ç‚¹

âœ… **é‰´æƒæˆåŠŸ**ï¼šçŠ¶æ€æ˜¾ç¤º"å·²é‰´æƒ"  
âœ… **è§£å¯†æ£€æµ‹**ï¼šæ—¥å¿—æ˜¾ç¤º"âœ“ åŠ å¯†æµ"  
âœ… **ç¡¬è§£ç å¯ç”¨**ï¼šè§£ç æ–¹å¼æ˜¾ç¤º"WebCodecsç¡¬è§£"  
âœ… **æ­£å¸¸æ’­æ”¾**ï¼šè§†é¢‘æµç•…æ— èŠ±å±  

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æç¤º"Thunder Player SDKæœªåŠ è½½"
**A**: æ£€æŸ¥`../../.temp/thunderwebplayer`è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œéœ€å…ˆä¸‹è½½å‚è€ƒé¡¹ç›®

### Q2: æç¤º"ThunderStone WASMæ¨¡å—æœªåŠ è½½"
**A**: æ£€æŸ¥`../thunder-decrypt/thunder_module.js`è·¯å¾„æ˜¯å¦æ­£ç¡®

### Q3: æ’­æ”¾æ—¶æç¤º"é‰´æƒå¤±è´¥"
**A**: æ£€æŸ¥`test-urls.json`ä¸­çš„appidå’Œsdk_sné…ç½®

### Q4: è§†é¢‘åŠ è½½ä½†ä¸æ’­æ”¾
**A**: æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

---

## ğŸ“š æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„æµ‹è¯•URL

ç¼–è¾‘`test-urls.json`ï¼š
```json
{
  "testUrls": {
    "encrypted": [
      {
        "title": "æ–°è§†é¢‘",
        "url": "https://example.com/video.ts",
        "format": "ts",
        "encrypted": true
      }
    ]
  }
}
```

### è‡ªå®šä¹‰é‰´æƒå‚æ•°

ä¿®æ”¹`index.html`ä¸­çš„`initSystem()`å‡½æ•°ï¼š
```javascript
const authResult = await state.authAdapter.init({
  appid: 'YOUR_APPID',
  uid: 'YOUR_UID',
  sdk_sn: 'YOUR_SDK_SN'
})
```

---

## ğŸ“ å­¦ä¹ èµ„æº

- [libmediaå®˜æ–¹æ–‡æ¡£](../../site/docs/)
- [AVPlayer APIå‚è€ƒ](../../site/docs/avplayer.md)
- [CustomIOLoaderå¼€å‘æŒ‡å—](../../site/docs/io.md)
- [ThunderStoneè§£å¯†åŸç†](../thunder-decrypt/README.md)

---

## ğŸ“ å¼€å‘ç¬”è®°

### ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæ¶æ„ï¼Ÿ

1. **æœ€å¤§åŒ–å¤ç”¨**ï¼šThunderçš„é‰´æƒ+è§£å¯†èƒ½åŠ›å®Œå…¨ä¿ç•™
2. **é›¶ä¾µå…¥**ï¼šä¸ä¿®æ”¹libmediaå’ŒThunder SDKæºç 
3. **æ€§èƒ½æœ€ä¼˜**ï¼šç¡¬è§£ç  + WASMè§£å¯†å¹¶è¡Œ
4. **æ˜“äºç»´æŠ¤**ï¼šæ¸…æ™°çš„åˆ†å±‚æ¶æ„

### æŠ€æœ¯äº®ç‚¹

- âœ… ç¬¦åˆlibmediaçš„CustomIOLoaderè§„èŒƒ
- âœ… å®Œæ•´çš„ç¼“å†²åŒºç®¡ç†ï¼ˆé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼‰
- âœ… æ­£ç¡®çš„è§£å¯†offsetè®¡ç®—ï¼ˆä»512å¼€å§‹ï¼‰
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿ

---

**ğŸ‰ äº«å—æ··åˆæ’­æ”¾å™¨å¸¦æ¥çš„æè‡´æ€§èƒ½ï¼**
